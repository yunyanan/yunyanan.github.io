<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>å†…æ ¸ç¼–è¯‘çš„èƒŒå - YunYanan</title>
        <meta name="Description" content="ä¸ªäººåšå®¢"><meta property="og:title" content="å†…æ ¸ç¼–è¯‘çš„èƒŒå" />
<meta property="og:description" content="


Hey, ä¼šç¼–è¯‘å†…æ ¸äº†ä¹‹åè¿˜æƒ³çŸ¥é“å†…æ ¸ç¼–è¯‘èƒŒåçš„ Kbuild å— ğŸ˜" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yunyanan.github.io/exploring_kbuild/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-15T10:29:35+08:00" />
<meta property="article:modified_time" content="2020-05-02T19:46:37+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å†…æ ¸ç¼–è¯‘çš„èƒŒå"/>
<meta name="twitter:description" content="


Hey, ä¼šç¼–è¯‘å†…æ ¸äº†ä¹‹åè¿˜æƒ³çŸ¥é“å†…æ ¸ç¼–è¯‘èƒŒåçš„ Kbuild å— ğŸ˜"/>
<meta name="application-name" content="YunYanan">
<meta name="apple-mobile-web-app-title" content="YunYanan"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://yunyanan.github.io/exploring_kbuild/" /><link rel="prev" href="https://yunyanan.github.io/linux_kernel_compile/" /><link rel="next" href="https://yunyanan.github.io/devicetree/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "å†…æ ¸ç¼–è¯‘çš„èƒŒå",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/yunyanan.github.io\/exploring_kbuild\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/yunyanan.github.io\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "Linux, Kernel, Kbuild, Makefile, Kconfig","wordcount":  1919 ,
        "url": "https:\/\/yunyanan.github.io\/exploring_kbuild\/","datePublished": "2020-03-15T10:29:35+08:00","dateModified": "2020-05-02T19:46:37+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "xxxx",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/yunyanan.github.io\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"author": {
                "@type": "Person",
                "name": "YunYanan"
            },"description": ""
    }
    </script></head>
    <body><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="YunYanan"><span class="header-title-pre"><i class='far fa-paper-plane fa-fw'></i> </span>YunYanan</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ‰€æœ‰æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/categories/"> åˆ†ç±» </a><a class="menu-item" href="/about/"> å…³äº </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="YunYanan"><span class="header-title-pre"><i class='far fa-paper-plane fa-fw'></i> </span>YunYanan</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">æ‰€æœ‰æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">åˆ†ç±»</a><a class="menu-item" href="/about/" title="">å…³äº</a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">å†…æ ¸ç¼–è¯‘çš„èƒŒå</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>YunYanan</a></span>&nbsp;
                    <span class="post-category">æ”¶å½•äº<a href="/categories/linux/">
                                <i class="far fa-folder fa-fw"></i>Linux
                            </a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-03-15>2020-03-15</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>çº¦ 1919 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>é¢„è®¡é˜…è¯» 10 åˆ†é’Ÿ&nbsp;<span id="/exploring_kbuild/" class="leancloud_visitors" data-flag-title="å†…æ ¸ç¼–è¯‘çš„èƒŒå">
                        <i class="far fa-eye fa-fw"></i><span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#å‰è¨€">å‰è¨€</a></li>
    <li><a href="#kbuild--kconfig">Kbuild &amp;&amp; Kconfig</a>
      <ul>
        <li><a href="#make-config-çš„èƒŒå">make *config çš„èƒŒå</a>
          <ul>
            <li><a href="#outputmakefile">outputmakefile</a></li>
            <li><a href="#scripts_basic">scripts_basic</a></li>
            <li><a href="#force">FORCE</a></li>
            <li><a href="#config-ç›®æ ‡çš„å‘½ä»¤">%config ç›®æ ‡çš„å‘½ä»¤</a></li>
          </ul>
        </li>
        <li><a href="#vmlinux-ç”Ÿæˆçš„èƒŒå">vmlinux ç”Ÿæˆçš„èƒŒå</a>
          <ul>
            <li><a href="#vmlinux-deps">$(vmlinux-deps)</a></li>
            <li><a href="#autoksyms_recursive">autoksyms_recursive</a></li>
            <li><a href="#scriptslink-vmlinuxsh">scripts/link-vmlinux.sh</a></li>
          </ul>
        </li>
        <li><a href="#æ„å»ºçš„ç›®æ ‡">æ„å»ºçš„ç›®æ ‡</a></li>
      </ul>
    </li>
    <li><a href="#ç»“è¯­">ç»“è¯­</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div style="text-align: center">
<img src="/images/posts/exploring_kbuild/kbuild.png"/>
</div>
<p>Hey, ä¼šç¼–è¯‘å†…æ ¸äº†ä¹‹åè¿˜æƒ³çŸ¥é“å†…æ ¸ç¼–è¯‘èƒŒåçš„ <code>Kbuild</code> å— ğŸ˜</p>
<h2 id="å‰è¨€">å‰è¨€</h2>
<hr>
<p>æœ€è¿‘äº†è§£ <strong>Kbuild</strong> çš„æ—¶å€™, åœ¨ç½‘ä¸Šæœç´¢ç›¸å…³çš„å†…å®¹å‘ç°è®²è¿™æ–¹é¢å†…å®¹çš„æ–‡ç« æ¯”èµ·æ•™ä½ æ€
ä¹ˆç¼–è¯‘å†…æ ¸çš„æ–‡ç« æ•°é‡ä¸Šè¦å°‘å¾ˆå¤šã€‚ æˆ‘è§‰å¾—è¿™ä¹Ÿååº”å‡º <strong>Kbuild</strong> ç³»ç»Ÿç¡®å®æ˜¯å®¹æ˜“è¢«å¿½
è§†çš„ä¸€éš…ï¼Œ ä¹Ÿè¯´æ˜äº†ä¼šç¼–è¯‘å†…æ ¸çš„äººä¸å†å°‘æ•°ï¼Œä½†æ˜¯å»ç ”ç©¶è¿‡ <strong>Kbuild</strong> ç³»ç»Ÿçš„ï¼Œ å¯¹
<strong>Kbuild</strong> æ„Ÿå…´è¶£çš„äººåˆ™è¦å°‘å¾ˆå¤§ä¸€éƒ¨åˆ†ã€‚ ä¸‹é¢å‘¢æ¥è®²è®²æˆ‘å¯¹ <strong>Kbuild</strong> çš„ç†è§£ã€‚</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>æ³¨æ„<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ul>
<li>æœ¬æ–‡ä¸­æ˜¯ä»¥åœ¨ PC ä¸Šç¼–è¯‘ <code>GNU Linux</code> å†…æ ¸ä¸ºä¾‹ã€‚</li>
<li>æœ¬æ–‡ç ”ç©¶ä½¿ç”¨çš„å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š
<blockquote>
<p>VERSION = 5	<br>
PATCHLEVEL = 6 <br>
SUBLEVEL = 0	<br>
EXTRAVERSION = -rc3	<br>
NAME = Kleptomaniac Octopus</p>
</blockquote>
</li>
</ul>
</div>
        </div>
    </div>
<h2 id="kbuild--kconfig">Kbuild &amp;&amp; Kconfig</h2>
<hr>
<p>åˆšå¼€å§‹æ¥è§¦ <strong>GNU Linux</strong> å†…æ ¸çš„æ—¶å€™æˆ‘å°±çŸ¥é“åœ¨å†…æ ¸ä¸­æœ‰ä¸€ç³»åˆ—çš„ <strong>Kconfig</strong> å’Œ
<strong>Makefile</strong> æ–‡ä»¶ï¼Œ å†…æ ¸æºç çš„å¾ˆå¤šç›®å½•ä¸‹ä¹Ÿéƒ½æ˜¯ä¸€ä¸ª <strong>Kconfig</strong> æ–‡ä»¶æ­é…ä¸€ä¸ª
<strong>Makefile</strong> æ–‡ä»¶ã€‚æˆ‘çŸ¥é“ <strong>Kbuild</strong> è¿™ä¸ªåè¯çš„æ—¶å€™æ˜¯å¾ˆä¹…ä¹‹åäº†ã€‚ å½“çœ‹åˆ°è¿™ä¸ªè¯çš„
æ—¶å€™æˆ‘çš„ç¬¬ä¸€ååº”æ˜¯è§‰å¾— <strong>&ldquo;Kbuild&rdquo;</strong> å®ƒæ˜¯å†…æ ¸ä¸­å…·ä½“çš„æŸä¸ªé…ç½®æ–‡ä»¶æˆ–è€…ç¼–è¯‘è„šæœ¬ä¹‹ç±»
çš„ä¸œè¥¿ã€‚ ç½‘ä¸Šä¸€ä¼—æ–‡ç« ä¸­ä¹Ÿå¾ˆå°‘æœ‰ç›´æ¥ç»™ <strong>Kbuild</strong> ä¸‹ä¸€ä¸ªå®šä¹‰ï¼Œ æˆ‘åœ¨å®˜æ–¹çš„
<a href="https://www.kernel.org/doc/Documentation/kbuild/modules.txt" target="_blank" rel="noopener noreffer">å†…æ ¸æ–‡æ¡£ modules ç¯‡</a>
ä¸­æ‰¾åˆ°è¿™æ ·çš„ä¸€å¥è¯ï¼Œ ä¹Ÿç®—æ˜¯é€šä¿—æ˜“æ‡‚çš„ä»‹ç»äº† <strong>kbuild</strong>ï¼š</p>
<blockquote>
<p>&ldquo;kbuild&rdquo; is the build system used by the Linux kernel.</p>
</blockquote>
<p>è¿™é‡Œå®šä¹‰çš„ <strong>Kbuild</strong> æ˜¯ä»å¹¿ä¹‰ä¸Šæ¥è¯´çš„ <strong>Kbuild</strong>ã€‚ è€Œå†…æ ¸ä¸­ä¹Ÿå­˜åœ¨ä¸€äº›åå­—å°±æ˜¯
<strong>Kbuild</strong> çš„æ–‡ä»¶ï¼Œ é‚£è¿™äº›æ–‡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ è¿™å…¶å®æœ‰ä¸ªæœ‰è¶£çš„åœ°æ–¹ï¼Œ åœ¨
<a href="https://www.kernel.org/doc/Documentation/kbuild/makefiles.txt" target="_blank" rel="noopener noreffer">å†…æ ¸æ–‡æ¡£ makefiles ç¯‡</a>
ä¸­çš„ç¬¬ä¸‰èŠ‚æœ‰è¿™æ ·çš„ä¸€ä¸ªä»‹ç»ï¼š</p>
<blockquote>
<p>&ldquo;Most Makefiles within the kernel are kbuild Makefiles that use the kbuild
infrastructure. This chapter introduces the syntax used in the kbuild
makefiles. The preferred name for the kbuild files are &lsquo;Makefile&rsquo; but
&lsquo;Kbuild&rsquo; can be used and if both a &lsquo;Makefile&rsquo; and a &lsquo;Kbuild&rsquo; file exists,
then the &lsquo;Kbuild&rsquo; file will be used.&rdquo;</p>
</blockquote>
<p>æ‰€ä»¥è¯´æˆ‘ä¸Šé¢æåˆ°çš„æˆ‘çš„ç¬¬ä¸€æ„Ÿè§‰ä¹Ÿä¸èƒ½ç®—é”™ï¼Œ ä»ç‹­ä¹‰ä¸Šè®² <strong>Kbuild</strong> ä¹Ÿå¯ä»¥æŒ‡å†…æ ¸ä¸­çš„ç¼–
è¯‘è„šæœ¬ï¼Œ åªä¸è¿‡å®˜æ–¹æ›´æ¨èä½¿ç”¨ <strong>&ldquo;Makefile&rdquo;</strong> è¿™ä¸ªåå­—ã€‚</p>
<p>å…³äº <strong>Kconfig</strong>ï¼Œ è¿™é‡Œå…¶å®ä¸ç”¨æ›´å¤šçš„è§£é‡Šäº†ï¼Œå®ƒå°±æ˜¯æŒ‡å†…æ ¸çš„é…ç½®ï¼Œæ²¡æœ‰æ­§ä¹‰ã€‚ç½‘ä¸Šå¥½å¤š
æ–‡ç« æŠŠ <strong>Kconfig</strong> å’Œ Kbuild æ˜¯ä»¥å¹¶åˆ—çš„æ¶æ„è®²è§£çš„ï¼Œ è€Œå†…æ ¸ä¸­å…³äº <strong>Kconfig</strong> æ
è¿°æ–‡æ¡£åˆ™å…¨éƒ¨éƒ½å½’ç±»åœ¨ <strong>Kbuild</strong> ä¸‹çš„ã€‚ è¿™å…¶å®ä¹Ÿæ˜¯ä» å¹¿ä¹‰è¿˜æ˜¯ç‹­ä¹‰ä¸Šæ¥çœ‹å¾…
<strong>Kbuild</strong> çš„é—®é¢˜äº†ã€‚</p>
<p>æ„å»ºå†…æ ¸çš„ç¬¬ä¸€æ­¥å§‹ç»ˆæ˜¯é…ç½®å†…æ ¸ã€‚ åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿè®²äº†å¦‚ä½•é…ç½®å†…æ ¸ï¼Œ è¿™é‡Œå°±å…ˆæ¥çœ‹çœ‹
åœ¨ <code>menuconfig</code>, <code>xconfig</code> ç­‰è¿™äº›é…ç½®æ–¹å¼çš„èƒŒååˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<h3 id="make-config-çš„èƒŒå">make *config çš„èƒŒå</h3>
<hr>
<p>å½“æˆ‘ä»¬æ‰§è¡Œ <code>make menuconfig</code> æˆ– <code>make xconfig</code> ç­‰å‘½ä»¤æ—¶ï¼Œ åŒ¹é…åˆ°çš„æ˜¯é¡¶å±‚
<strong>Makefile</strong> ä¸­çš„ <code>%config</code> ç›®æ ‡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nf">%config</span><span class="o">:</span> <span class="n">outputmakefile</span> <span class="n">scripts_basic</span> <span class="n">FORCE</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span>scripts/kconfig <span class="nv">$@</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒæœ‰ä¸‰ä¸ªä¾èµ–ï¼š <code>outputmakefile</code>, <code>scripts_basic</code>, <code>FORCE</code> ä»¥åŠä¸€æ¡å‘½ä»¤ã€‚ æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ã€‚</p>
<h4 id="outputmakefile">outputmakefile</h4>
<p>æˆ‘æŠŠ outputmakefile ç›®æ ‡çš„æ¥æºä»¥åŠå®ƒæ‰€ä¾èµ–çš„ä¸€äº›å˜é‡æ¥æºä»é¡¶å±‚ Makefile ä¸­æ‹¿
å‡ºæ¥æ”¾åœ¨äº†ä¸€èµ·ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c">#####################
</span></span></span><span class="line"><span class="cl"><span class="c"># abs_objtree å˜é‡æ¥æº
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifeq</span> <span class="err">(</span><span class="s2">&#34;$(origin O)&#34;</span><span class="err">,</span> <span class="s2">&#34;command line&#34;</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">KBUILD_OUTPUT</span> <span class="o">:=</span> <span class="k">$(</span>O<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifneq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">KBUILD_OUTPUT</span><span class="k">)</span><span class="err">,)</span>
</span></span><span class="line"><span class="cl"><span class="c"># Make&#39;s built-in functions such as $(abspath ...), $(realpath ...) cannot
</span></span></span><span class="line"><span class="cl"><span class="c"># expand a shell special character &#39;~&#39;. We use a somewhat tedious way here.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">abs_objtree</span> <span class="o">:=</span> <span class="k">$(</span>shell mkdir -p <span class="k">$(</span>KBUILD_OUTPUT<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="k">$(</span>KBUILD_OUTPUT<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">$(</span><span class="nv">if</span> <span class="k">$(</span><span class="nv">abs_objtree</span><span class="k">)</span>,, \
</span></span><span class="line"><span class="cl">     <span class="k">$(</span><span class="nv">error</span> <span class="nv">failed</span> <span class="nv">to</span> <span class="nv">create</span> <span class="nv">output</span> <span class="nv">directory</span> &#34;<span class="k">$(</span><span class="nv">KBUILD_OUTPUT</span><span class="k">)</span>&#34;<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># $(realpath ...) resolves symlinks
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">abs_objtree</span> <span class="o">:=</span> <span class="k">$(</span>realpath <span class="k">$(</span>abs_objtree<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl"><span class="nv">abs_objtree</span> <span class="o">:=</span> <span class="k">$(</span>CURDIR<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span> <span class="c"># ifneq ($(KBUILD_OUTPUT),)
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="c">#####################
</span></span></span><span class="line"><span class="cl"><span class="c"># abs_srctree å˜é‡æ¥æº
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="nv">abs_srctree</span> <span class="o">:=</span> <span class="k">$(</span>realpath <span class="k">$(</span>dir <span class="k">$(</span>lastword <span class="k">$(</span>MAKEFILE_LIST<span class="k">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">################################
</span></span></span><span class="line"><span class="cl"><span class="c"># building_out_of_srctree å˜é‡æ¥æº
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">abs_srctree</span><span class="k">)</span><span class="err">,</span><span class="k">$(</span><span class="nv">abs_objtree</span><span class="k">)</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">        <span class="c"># building in the source tree
</span></span></span><span class="line"><span class="cl"><span class="c"></span>        srctree :<span class="o">=</span> .
</span></span><span class="line"><span class="cl">	building_out_of_srctree :<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl">        <span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">abs_srctree</span><span class="k">)</span><span class="err">/,</span><span class="k">$(</span><span class="nv">dir</span> <span class="k">$(</span><span class="nv">abs_objtree</span><span class="k">))</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">                <span class="c"># building in a subdirectory of the source tree
</span></span></span><span class="line"><span class="cl"><span class="c"></span>                srctree :<span class="o">=</span> ..
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                srctree :<span class="o">=</span> <span class="k">$(</span>abs_srctree<span class="k">)</span>
</span></span><span class="line"><span class="cl">        endif
</span></span><span class="line"><span class="cl">	building_out_of_srctree :<span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#####################
</span></span></span><span class="line"><span class="cl"><span class="c"># outputmakefile ç›®æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="nf">outputmakefile</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">building_out_of_srctree</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)</span><span class="err">if</span> <span class="err">[</span> <span class="err">-f</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/.config</span> <span class="err">-o</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		 <span class="err">-d</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/include/config</span> <span class="err">-o</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		 <span class="err">-d</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/arch/</span><span class="k">$(</span><span class="nv">SRCARCH</span><span class="k">)</span><span class="err">/include/generated</span> <span class="err">];</span> <span class="err">then</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;***&#34;</span><span class="err">;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;*** The source tree is not clean, please run &#39;make$(if $(findstring command line, $(origin ARCH)), ARCH=$(ARCH)) mrproper&#39;&#34;</span><span class="err">;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;*** in $(abs_srctree)&#34;</span><span class="err">;\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;***&#34;</span><span class="err">;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">false;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">	<span class="err">fi</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)</span><span class="err">ln</span> <span class="err">-fsn</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span> <span class="err">source</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)$(</span><span class="nv">CONFIG_SHELL</span><span class="k">)</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/scripts/mkmakefile</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)</span><span class="err">test</span> <span class="err">-e</span> <span class="err">.gitignore</span> <span class="err">||</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">	<span class="err">{</span> <span class="err">echo</span> <span class="s2">&#34;# this is build directory, ignore it&#34;</span><span class="err">;</span> <span class="err">echo</span> <span class="s2">&#34;*&#34;</span><span class="err">;</span> <span class="err">}</span> <span class="err">&gt;</span> <span class="err">.gitignore</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä»ä¸‹å¾€ä¸Šçœ‹ï¼Œ <code>outputmakefile</code> ç›®æ ‡çš„å†…å®¹æ˜¯å¦æœ‰æ•ˆå–å†³äºè¿™æ ·çš„ä¸€ä¸ªä¾èµ–å…³ç³»é“¾ï¼š</p>
<pre><code>outputmakefile --&gt; building_out_of_srctree --&gt; abs_srctree, abs_objtree
</code></pre>
<ul>
<li>
<p><code>abs_objtree</code> å–å†³äºå‘½ä»¤è¡Œæ˜¯å¦æœ‰ <code>O=DIR</code> å‚æ•°ä¼ å…¥ã€‚ <strong>DIR</strong> è¡¨ç¤ºç¼–è¯‘è¾“å‡ºæ–‡ä»¶çš„
å­˜æ”¾è·¯å¾„ï¼Œ é»˜è®¤æ˜¯åœ¨æºç è·¯å¾„ä¸‹ã€‚ å¦‚æœæœ‰è¿™ä¸ªå‚æ•°ä¼ å…¥åˆ™ <code>abs_objtree</code> çš„å€¼ä¸ºä¼ å…¥
çš„è·¯å¾„ï¼Œå¦åˆ™ä¸ºæºç è·¯å¾„ã€‚</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>æ³¨æ„<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">å½“æŒ‡å®šäº† <code>O=DIR</code> å‚æ•°çš„æ—¶å€™ <strong>Makefile</strong> ä¸ä»…ä¼šå»åˆ›å»ºè¿™ä¸ªç›®å½•ï¼Œå¹¶ä¸”ä¼šå°†å·¥ä½œè·¯
å¾„åˆ‡æ¢åˆ° <strong>DIR</strong> è¿™ä¸ªè·¯å¾„å»ã€‚</div>
        </div>
    </div>
</li>
<li>
<p><code>abs_srctree</code> æ˜¯ç”± <code>MAKEFILE_LIST</code> å˜é‡ç»è¿‡ <code>lastword</code>, <code>dir</code>, <code>realpath</code> å‡ ä¸ªå‡½
æ•°å¤„ç†åå¾—åˆ°çš„ç»“æœï¼Œæœ€åçš„ç»“æœæ˜¯é¡¶å±‚ <strong>Makefile</strong> çš„ç»å¯¹è·¯å¾„ã€‚</p>
</li>
<li>
<p><code>building_out_of_srctree</code> çš„å€¼åˆ™å–å†³äº <code>abs_objtree</code> å’Œ <code>abs_srctree</code> æ˜¯å¦ç›¸ç­‰ï¼Œ
ä¸ç›¸ç­‰æ—¶ <code>building_out_of_srctree</code> çš„å€¼ä¸º 1ï¼Œ å¦åˆ™ä¸ºç©ºã€‚</p>
</li>
<li>
<p>åˆ°è¿™é‡Œå…¶å®å¯ä»¥çœ‹å¾—å‡º <code>outputmakefile</code> è¿™ä¸ªç›®æ ‡æ˜¯ä¸º <code>O=DIR</code> è¿™ä¸ªå‚æ•°æœåŠ¡çš„ã€‚ å®ƒçœŸæ­£
åšäº†è¿™ä¹ˆä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>åœ¨ <strong>DIR</strong> è·¯å¾„ä¸‹åˆ›å»ºäº†æºç ç›®å½•çš„è½¯é“¾æ¥ã€‚</li>
<li>æ‰§è¡Œäº† <code>$(srctree)/scripts/mkmakefile $(srctree)</code> è¿™æ¡ <strong>shell</strong> å‘½ä»¤ã€‚</li>
</ol>
<p>å…³é”®åœ¨äºç¬¬äºŒæ¡ï¼Œ è¿™æ¡å‘½ä»¤æ˜¯å»æ‰§è¡Œæºç è·¯å¾„ä¸‹çš„ <code>scripts/mkmakefile</code> è„šæœ¬ï¼Œå¹¶ä¸”å°†
æºç è·¯å¾„ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚è€Œè¿™ä¸ªè„šæœ¬çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF &gt; Makefile
</span></span></span><span class="line"><span class="cl"><span class="s"># Automatically generated by $0: don&#39;t edit
</span></span></span><span class="line"><span class="cl"><span class="s">include $1/Makefile
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯åœ¨ <strong>DIR</strong> è·¯å¾„ä¸‹åˆ›å»ºå‡ºä¸€ä¸ª <strong>Makefile</strong> æ–‡ä»¶å¹¶åŒ…å«æºç ç›®å½•ä¸‹çš„é¡¶
å±‚ <strong>Makefile</strong>ã€‚</p>
</li>
</ul>
<h4 id="scripts_basic">scripts_basic</h4>
<p><code>scripts_basic</code> ç›®æ ‡çš„å†…å®¹æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nf">scripts_basic</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span>scripts/basic
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)</span>rm -f .tmp_quiet_recordmcount
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>ä¿¡æ¯<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">å˜é‡ <code>$(Q)</code> æ˜¯å®šä¹‰åœ¨é¡¶å±‚ <strong>Makefile</strong> ä¸­çš„ï¼Œ å®ƒçš„ä½œç”¨æ˜¯ç¼–è¯‘æ—¶æ§åˆ¶ <strong>Makefile</strong>
å¦è¦å›æ˜¾å‘½ä»¤ã€‚ å®ƒçš„å€¼å–å†³äºå‘½ä»¤è¡Œæœ‰æ²¡æœ‰ <code>V=1</code> çš„å‚æ•°ä¼ å…¥ï¼Œå¦‚æœæœ‰è¿™ä¸ªå‚æ•°ä¼ å…¥ï¼Œ
<code>$(Q)</code> çš„å€¼ä¸ºç©ºï¼Œ å¦åˆ™ä¸º <code>@</code>ã€‚ åœ¨è¿™é‡Œåˆ†æ <strong>Makefile</strong> æ—¶éƒ½å¯ä»¥å…ˆå¿½ç•¥å®ƒã€‚</div>
        </div>
    </div>
<p>è¿™é‡Œé¢æ¯”è¾ƒéº»çƒ¦çš„æ˜¯ <code>build</code> è¿™ä¸ªå˜é‡ï¼Œå…¶å®å®ƒæ˜¯å®šä¹‰åœ¨äº† <strong>&ldquo;scripts/Kbuild.include&rdquo;</strong>
ä¸­ã€‚ å®ƒçš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c">###
</span></span></span><span class="line"><span class="cl"><span class="c"># Shorthand for $(Q)$(MAKE) -f scripts/Makefile.build obj=
</span></span></span><span class="line"><span class="cl"><span class="c"># Usage:
</span></span></span><span class="line"><span class="cl"><span class="c"># $(Q)$(MAKE) $(build)=dir
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">build</span> <span class="o">:=</span> -f <span class="k">$(</span>srctree<span class="k">)</span>/scripts/Makefile.build obj
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæ³¨é‡Šä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæŠŠå®ƒå®šä¹‰æˆè¿™æ ·å’Œæ€ä¹ˆä½¿ç”¨å®ƒã€‚è€Œ <code>MAKE</code> å˜é‡æ˜¯ <code>GNU make</code> å®šä¹‰
çš„å˜é‡ï¼Œä¸€èˆ¬å®ƒçš„å€¼éƒ½æ˜¯ <code>make</code>ï¼Œ æœ‰å…³å®ƒçš„è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒ
<a href="https://www.gnu.org/software/make/manual/html_node/MAKE-Variable.html" target="_blank" rel="noopener noreffer">è¿™é‡Œ</a>ã€‚
æ‰€ä»¥ä¸Šé¢ <code>$(Q)$(MAKE) $(build)=scripts/basic</code> è¿™æ¡è§„åˆ™å¯ä»¥å±•å¼€æˆè¿™æ ·ï¼š
<code>make -f $(srctree)/scripts/Makefile.build obj=scripts/basic</code>ã€‚
è¿™é‡Œæ²¡æœ‰æŒ‡å®šç›®æ ‡ï¼Œæ‰€ä»¥ç¼–è¯‘çš„æ˜¯ <code>Makefile.build</code> çš„é»˜è®¤ç›®æ ‡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nf">__build</span><span class="o">:</span> <span class="k">$(</span><span class="nv">if</span> <span class="k">$(</span><span class="nv">KBUILD_BUILTIN</span><span class="k">)</span>,<span class="k">$(</span><span class="nv">builtin</span>-<span class="nv">target</span><span class="k">)</span> <span class="k">$(</span><span class="nv">lib</span>-<span class="nv">target</span><span class="k">)</span> <span class="k">$(</span><span class="nv">extra</span>-<span class="nv">y</span><span class="k">))</span> \
</span></span><span class="line"><span class="cl">	 <span class="k">$(</span><span class="nv">if</span> <span class="k">$(</span><span class="nv">KBUILD_MODULES</span><span class="k">)</span>,<span class="k">$(</span><span class="nv">obj</span>-<span class="nv">m</span><span class="k">)</span> <span class="k">$(</span><span class="nv">mod</span>-<span class="nv">targets</span><span class="k">)</span> <span class="k">$(</span><span class="nv">modorder</span>-<span class="nv">target</span><span class="k">))</span> \
</span></span><span class="line"><span class="cl">	 <span class="k">$(</span><span class="nv">subdir</span>-<span class="nv">ym</span><span class="k">)</span> <span class="k">$(</span><span class="nv">always</span>-<span class="nv">y</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">	@:
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“é…ç½®å†…æ ¸æ—¶ï¼Œ <strong>$(KBUILD_BUILTIN)</strong>ï¼Œ <strong>$(KBUILD_MODULES)</strong>ï¼Œ <strong>$(subdir-ym)</strong> çš„å€¼éƒ½ä¸ºç©ºï¼Œ æ‰€ä»¥
åªæœ‰ <strong>$(always-y)</strong> ç›®æ ‡æœ‰æ•ˆ, æ­¤æ—¶ <strong>$(always-y)</strong> çš„å€¼ä¸º <code>fixdep</code>ã€‚
æ‰€ä»¥ <code>scripts_basic</code> è¿™ä¸ªç›®æ ‡å…¶å®æ˜¯å»ç¼–è¯‘äº† <code>scripts/basic</code> ä¸‹çš„æºç ç”Ÿæˆ <code>fixdep</code> å·¥å…·ã€‚</p>
<p>å…³äº <strong>fixdep</strong> å·¥å…·çš„ä½œç”¨åœ¨ <code>scripts/basic/Makefile</code> é‡Œæœ‰ä¸€æ®µè¿™æ ·çš„è§£é‡Šï¼š</p>
<blockquote>
<p>fixdep: used to generate dependency information during build process</p>
</blockquote>
<p>åœ¨è¿™é‡Œå°±ä¸å¯¹ <strong>fixdep</strong> å·¥å…·å±•å¼€è¯¦ç»†åˆ†æäº†ã€‚</p>
<h4 id="force">FORCE</h4>
<p><code>FORCE</code> ç›®æ ‡æ˜¯å®šä¹‰åœ¨é¡¶å±‚ <strong>Makefile</strong> çš„æœ€åï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nv">PHONY</span> <span class="o">+=</span> FORCE
</span></span><span class="line"><span class="cl"><span class="nf">FORCE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Declare the contents of the PHONY variable as phony.  We keep that
</span></span></span><span class="line"><span class="cl"><span class="c"># information in a variable so we can use it in if_changed and friends.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nf">.PHONY</span><span class="o">:</span> <span class="k">$(</span><span class="nv">PHONY</span><span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼Œ åœ¨ <strong>Makefile</strong> ä¸­ <code>FORCE</code> ç›®æ ‡å¹¶æ²¡æœ‰ä¾èµ–ï¼Œ
ä¹Ÿæ²¡æœ‰è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œ ä½†æ˜¯ <code>FORCE</code> ç›®æ ‡çš„ä½¿ç”¨å´ä¸æ­¢ä¸€å¤„ä¸¤å¤„ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç”¨
å‘¢ï¼Ÿ è¿™ä¸ªç­”æ¡ˆå…¶å® <code>GNU Make</code> å®˜æ–¹å°±å·²ç»ç»™å‡ºäº†ï¼š</p>
<blockquote>
<p>If a rule has no prerequisites or recipe, and the target of the rule is a
nonexistent file, then make imagines this target to have been updated whenever
its rule is run. This implies that all targets depending on this one will
always have their recipe run.</p>
</blockquote>
<p>ç®€è€Œè¨€ä¹‹å°±æ˜¯è¿™æ ·å®šä¹‰å‡ºçš„ <code>FORCE</code> ç›®æ ‡åœ¨ä½¿ç”¨æ—¶å…¶å®å¯ä»¥æŠŠå®ƒå½“æˆä¸€ä¸ªå…³é”®å­—ï¼Œ å¦‚æœä¾
èµ–ä¸­åŠ ä¸Š <code>FORCE</code> çš„è¯, <strong>make</strong> å·¥å…·ä¾¿ä¼šè®¤ä¸ºè¿™ä¸ªç›®æ ‡çš„ä¾èµ–æ›´æ–°è¿‡ï¼Œ éœ€è¦é‡æ–°ç”Ÿæˆ
è¿™ä¸ªç›®æ ‡ã€‚ è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒ <code>GNU Make</code>
<a href="https://www.gnu.org/software/make/manual/html_node/Force-Targets.html" target="_blank" rel="noopener noreffer">å®˜æ–¹æ‰‹å†Œ</a>ã€‚</p>
<h4 id="config-ç›®æ ‡çš„å‘½ä»¤">%config ç›®æ ‡çš„å‘½ä»¤</h4>
<p><code>%config</code> çš„å‘½ä»¤åŸæœ¬æ˜¯è¿™æ ·çš„ï¼š <code>$(Q)$(MAKE) $(build)=scripts/kconfig $@</code>ã€‚ è¿™æ¡
å‘½ä»¤å±•å¼€åå°±å˜æˆäº†è¿™æ ·ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="err">make</span> <span class="err">-f</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/scripts/Makefile.build</span> <span class="nv">obj</span><span class="o">=</span>scripts/kconfig %config
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºï¼Œ å®ƒåˆå»è°ƒç”¨äº† <code>scripts/Makefile.build</code> æ–‡ä»¶ï¼Œ åªä¸è¿‡æ­¤æ—¶æœ‰å‚æ•°
<code>obj=scripts/kconfig</code>ï¼Œ æœ‰ç›®æ ‡ <code>%config</code>ã€‚</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>ä¿¡æ¯<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">è¿™é‡Œç›®æ ‡ <code>%config</code> åœ¨ä¼ å…¥ <code>scripts/Makefile.build</code> æ—¶å°±æ˜¯åœ¨æ‰§è¡Œ <code>make</code> æ—¶ä¼ å…¥çš„
ç›®æ ‡ã€‚ ä¾‹å¦‚ä½¿ç”¨çš„æ˜¯ <code>make menuconfig</code> å‘½ä»¤é…ç½®å†…æ ¸ï¼Œ è¿™é‡Œç›®æ ‡å°±æ˜¯ <code>menuconfig</code>ã€‚</div>
        </div>
    </div>
<p>å› ä¸ºä¼ å…¥äº†å‚æ•° <code>obj=scripts/kconfig</code>ï¼Œ æ‰€ä»¥ <code>srcipts/kconfig</code> ç›®å½•ä¸‹çš„
<code>Makefile</code> ä¼šè¢«åŒ…å«è¿›æ¥ã€‚ å¯¹åº”çš„ <code>%config</code> ç›®æ ‡ä¹Ÿéƒ½åœ¨å…¶ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c">################
</span></span></span><span class="line"><span class="cl"><span class="c"># Kconfig å˜é‡å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">KBUILD_KCONFIG</span>
</span></span><span class="line"><span class="cl"><span class="nv">Kconfig</span> <span class="o">:=</span> <span class="k">$(</span>KBUILD_KCONFIG<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl"><span class="nv">Kconfig</span> <span class="o">:=</span> Kconfig
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifndef</span> <span class="err">KBUILD_DEFCONFIG</span>
</span></span><span class="line"><span class="cl"><span class="nv">KBUILD_DEFCONFIG</span> <span class="o">:=</span> defconfig
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">###############
</span></span></span><span class="line"><span class="cl"><span class="c"># silent å˜é‡å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">quiet</span><span class="k">)</span><span class="err">,silent_)</span>
</span></span><span class="line"><span class="cl"><span class="nv">silent</span> <span class="o">:=</span> -s
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">################
</span></span></span><span class="line"><span class="cl"><span class="c"># %config ç›®æ ‡å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="nf">xconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">qconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">gconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">menuconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">mconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">config</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">conf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> --oldaskconfig <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">nconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">nconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»§ç»­ä»¥ <code>menuconfig</code> ç›®æ ‡ä¸ºä¾‹ï¼Œ å®ƒæœ‰ä¸€ä¸ªä¾èµ– <code>$(obj)/mconf</code>ã€‚ è¿™ä¸ª <code>mconf</code> å…¶å®æ˜¯
ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œ è€Œè¿™é‡Œçš„ä¾èµ–ä¹Ÿå°±æ˜¯å®ƒçš„ç”Ÿæˆè¿‡ç¨‹ã€‚ å…³äºå®ƒçš„ç”Ÿæˆè¿‡ç¨‹ä¹Ÿè¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œ
ä¸‹é¢æ˜¯æˆ‘æ•´ç†å‡ºæ¥çš„å®ƒçš„ä¾èµ–å…³ç³»å›¾ï¼Œ å…¶ä»–çš„å‡ ä¸ªç›®æ ‡ä¹Ÿæ˜¯å¤§åŒå°å¼‚ï¼Œ è¿™é‡Œæˆ‘å°±ä¸å±•å¼€åˆ†
æäº†ã€‚ è¿™éƒ¨åˆ†å·¥ä½œä¸»è¦æ˜¯åœ¨ <code>scripts/Makefile.host</code> å’Œ <code>scripts/kconfig/Makefile</code>
ä¸­å®ç°çš„ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading/small.min.svg"
        data-src="/images/posts/exploring_kbuild/menuconfig.png"
        data-srcset="/images/posts/exploring_kbuild/menuconfig.png, /images/posts/exploring_kbuild/menuconfig.png 1.5x, /images/posts/exploring_kbuild/menuconfig.png 2x"
        data-sizes="auto"
        alt="menuconfig"
        title="menuconfig" /></p>
<p>å›è¿‡å¤´æ¥ï¼Œ <code>menuconfig</code> çš„å‘½ä»¤å±•å¼€åæ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="err">scripts/kconfig/mconf</span> <span class="err">Kconfig</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶å®å°±æ˜¯è°ƒç”¨äº†ç”Ÿæˆçš„ <code>mconf</code> ç¨‹åºï¼Œ å¹¶æŠŠ <code>Kconfig</code> ä½œä¸ºè¾“å…¥å‚æ•°ã€‚ è¿™é‡Œçš„
<code>Kconfig</code> ä¾¿æ˜¯æŒ‡æºç æ ¹ç›®å½•ä¸‹çš„ <code>Kconfig</code> æ–‡ä»¶ï¼Œ ç›®çš„å°±æ˜¯ç”¨ <code>mconf</code> å»è§£æè¿™ä¸ªæ–‡
ä»¶ã€‚ é¡¶å±‚çš„ <code>Kconfig</code> å†…å®¹å¹¶ä¸å¤æ‚ï¼Œ åŸºæœ¬éƒ½æ˜¯å»åŒ…å«å„ä¸ªå­æ¨¡å—ä¸‹çš„ <code>Kconfig</code> æ–‡ä»¶ã€‚
è§£æå®Œä¹‹åå¼€å§‹æ„å»ºåˆå§‹é…ç½®æ•°æ®åº“ï¼Œ ç„¶åæ ¹æ®ä»¥ä¸‹ä¼˜å…ˆçº§è¯»å–ç°æœ‰é…ç½®æ–‡ä»¶æ¥æ›´æ–°åˆå§‹
æ•°æ•°æ®åº“ï¼š</p>
<ul>
<li>.config</li>
<li>/lib/modules/$(shell,uname -r)/.config</li>
<li>/etc/kernel-config</li>
<li>/boot/config-$(shell,uname -r)</li>
<li>ARCH_DEFCONFIG</li>
<li>arch/$(ARCH)/defconfig</li>
</ul>
<p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>GUI</code> ç•Œé¢å¼€å§‹é…ç½®å†…æ ¸ï¼Œ å®Œæˆåä¼šç”Ÿæˆ <code>.config</code> æ–‡ä»¶ã€‚æ‰€ä»¥æ•´
ä¸ªé…ç½®è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading/small.min.svg"
        data-src="/images/posts/exploring_kbuild/config_flow.png"
        data-srcset="/images/posts/exploring_kbuild/config_flow.png, /images/posts/exploring_kbuild/config_flow.png 1.5x, /images/posts/exploring_kbuild/config_flow.png 2x"
        data-sizes="auto"
        alt="config flow"
        title="config flow" /></p>
<h3 id="vmlinux-ç”Ÿæˆçš„èƒŒå">vmlinux ç”Ÿæˆçš„èƒŒå</h3>
<p>é€šè¿‡ä¸Šé¢å¯¹å†…æ ¸é…ç½®è¿‡ç¨‹çš„åˆ†æï¼Œ <strong>kbuild</strong> çš„å¥—è·¯ä¹Ÿè¢«æ­éœ²äº†ä¸€äºŒã€‚ è€Œç¼–è¯‘ <code>vmlinux</code>
ç›®æ ‡å¯ä»¥è¯´æ˜¯ <code>kbuild</code> ç³»ç»Ÿçš„æ ¸å¿ƒä»»åŠ¡äº†ã€‚ å†…æ ¸çš„æ¶æ„è¢«åˆ†æˆäº†ä¸åŒçš„æ¨¡å—ï¼Œ æ¯ä¸ªæ¨¡å—
éƒ½ç”±å®ƒè‡ªå·±åœ¨ <code>Makefile</code> ç®¡ç†ã€‚ å½“ç¼–è¯‘å†…æ ¸æ—¶ï¼Œ é¡¶å±‚çš„ <code>Makefile</code> ä¼šæŒ‰ç…§æ­£ç¡®çš„é¡ºåº
è°ƒç”¨å¯¹åº”æ¨¡å—çš„ <code>Makefile</code>ï¼Œ é€’å½’çš„è¿›è¡Œç¼–è¯‘ã€‚ å› æ­¤ï¼Œ å†…æ ¸ä¸­çš„ <code>Makefile</code> ä¹Ÿè¢«åˆ†æˆ
äº†ä¸‹é¢çš„è¿™å‡ éƒ¨åˆ†ï¼š</p>
<pre><code>Makefile		the top Makefile.
 .config			the kernel configuration file.
 arch/$(ARCH)/Makefile	the arch Makefile.
 scripts/Makefile.*	common rules etc. for all kbuild Makefiles.
 kbuild Makefiles	there are about 500 of these.
</code></pre>
<p>æ²¡é”™ï¼Œå°±æ˜¯åœ¨å®ƒä»¬çš„å…±åŒåŠªåŠ›ä¸‹ç¼–è¯‘å‡ºäº† <code>vmlinux</code>ã€‚ æˆ‘æŠŠ <strong>vmlinux</strong> ç¼–è¯‘çš„ç¼–è¯‘æ•´ç†
æˆäº†ä¸‹é¢è¿™å¼ ä¾èµ–å…³ç³»å›¾ï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading/small.min.svg"
        data-src="/images/posts/exploring_kbuild/vmlinux.png"
        data-srcset="/images/posts/exploring_kbuild/vmlinux.png, /images/posts/exploring_kbuild/vmlinux.png 1.5x, /images/posts/exploring_kbuild/vmlinux.png 2x"
        data-sizes="auto"
        alt="vmlinux"
        title="vmlinux" /></p>
<p>é‚£æ¥ä¸‹æ¥å°±æ¥è®²ä¸€ä¸‹ç¼–è¯‘æ—¶æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚ ä»ä¸Šé¢çš„å›¾ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ <code>vmlinux</code> çš„ä¾èµ–
æœ‰ä¸‰å¤§å—ã€‚</p>
<h4 id="vmlinux-deps">$(vmlinux-deps)</h4>
<p>è¿™éƒ¨åˆ†ä¸»è¦æ˜¯è´Ÿè´£æºç éƒ¨åˆ†çš„ç¼–è¯‘ï¼Œ ä»å˜é‡çš„åå­—ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºï¼Œè¿™
ä¸ªå˜é‡å±äº <code>vmlinux</code> çš„ä¾èµ–ã€‚ å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ è¿™éƒ¨åˆ†æœ€ç»ˆçš„ä¾èµ–åŸºæœ¬éƒ½æ˜¯åä¸º
<code>built-in.a</code> çš„æ–‡ä»¶ï¼Œ é‚£è¿™äº›æ–‡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦ä¸€ä¸ªé—®é¢˜ï¼Œ åœ¨ä¸Šé¢æåˆ°è¿‡ï¼Œ
<code>kbuild</code> ç³»ç»Ÿçš„ç¼–è¯‘æ˜¯é‡‡ç”¨é€’å½’çš„æ–¹å¼è¿›è¡Œçš„, é‚£è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ è¿™ä¸ªç§˜å¯†åœ¨
<code>scripts/Makefile.build</code> å’Œ <code>scripts/Makefile.lib</code> ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c"># Handle objects in subdirs
</span></span></span><span class="line"><span class="cl"><span class="c"># ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c"># o if we encounter foo/ in $(obj-y), replace it by foo/built-in.a
</span></span></span><span class="line"><span class="cl"><span class="c">#   and add the directory to the list of dirs to descend into: $(subdir-y)
</span></span></span><span class="line"><span class="cl"><span class="c"># o if we encounter foo/ in $(obj-m), remove it from $(obj-m)
</span></span></span><span class="line"><span class="cl"><span class="c">#   and add the directory to the list of dirs to descend into: $(subdir-m)
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">__subdir-y</span>	<span class="o">:=</span> <span class="k">$(</span>patsubst %/,%,<span class="k">$(</span>filter %/, <span class="k">$(</span>obj-y<span class="k">)))</span>
</span></span><span class="line"><span class="cl"><span class="nv">subdir-y</span>	<span class="o">+=</span> <span class="k">$(</span>__subdir-y<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">__subdir-m</span>	<span class="o">:=</span> <span class="k">$(</span>patsubst %/,%,<span class="k">$(</span>filter %/, <span class="k">$(</span>obj-m<span class="k">)))</span>
</span></span><span class="line"><span class="cl"><span class="nv">subdir-m</span>	<span class="o">+=</span> <span class="k">$(</span>__subdir-m<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Subdirectories we need to descend into
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">subdir-ym</span>	<span class="o">:=</span> <span class="k">$(</span>sort <span class="k">$(</span>subdir-y<span class="k">)</span> <span class="k">$(</span>subdir-m<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nv">subdir-ym</span>	<span class="o">:=</span> <span class="k">$(</span>addprefix <span class="k">$(</span>obj<span class="k">)</span>/,<span class="k">$(</span>subdir-ym<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># $(subdir-obj-y) is the list of objects in $(obj-y) which uses dir/ to
</span></span></span><span class="line"><span class="cl"><span class="c"># tell kbuild to descend
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">subdir-obj-y</span> <span class="o">:=</span> <span class="k">$(</span>filter %/built-in.a, <span class="k">$(</span>obj-y<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">$(subdir-ym)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span><span class="nv">$@</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="k">$(if</span> <span class="k">$(</span>filter <span class="nv">$@</span>/, <span class="k">$(</span>KBUILD_SINGLE_TARGETS<span class="k">))</span>,single-build<span class="o">=</span><span class="k">)</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	need-builtin<span class="o">=</span><span class="k">$(if</span> <span class="k">$(</span>filter <span class="nv">$@</span>/built-in.a, <span class="k">$(</span>subdir-obj-y<span class="k">))</span>,1<span class="k">)</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	need-modorder<span class="o">=</span><span class="k">$(if</span> <span class="k">$(</span>need-modorder<span class="k">)</span>,<span class="k">$(if</span> <span class="k">$(</span>filter <span class="nv">$@</span>/modules.order, <span class="k">$(</span>modorder<span class="k">))</span>,1<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">need-builtin</span>
</span></span><span class="line"><span class="cl"><span class="nv">builtin-target</span> <span class="o">:=</span> <span class="k">$(</span>obj<span class="k">)</span>/built-in.a
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">$(builtin-target)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">real</span>-<span class="nv">obj</span>-<span class="nv">y</span><span class="k">)</span> <span class="n">FORCE</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>call if_changed,ar_builtin<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢è¿™äº›å†…å®¹æ˜¯ä»é‚£ä¸¤ä¸ª <code>Makefile</code> ä¸­æ‘˜æŠ„å‡ºæ¥çš„ï¼Œ ä»–ä»¬å¹¶ä¸åœ¨ä¸€èµ·ã€‚ è¿™ç‚¹ä¸œè¥¿æˆ‘è§‰å¾—åº”è¯¥ç®—
æ˜¯ <code>kbuild</code> ç³»ç»ŸåŠå…¶æ ¸å¿ƒçš„ä¸€ä¸ªéƒ¨åˆ†äº†ã€‚ <code>obj-y/m</code> å˜é‡ä¸­å­˜æ”¾çš„æ˜¯éœ€è¦ç¼–è¯‘çš„æ–‡ä»¶å’Œ
éœ€è¦é€’å½’è¿›å…¥çš„ç›®å½•ã€‚ <code>kbuild Makefiles</code> ä¸­çš„å†…å®¹å¤§å¤šéƒ½æ˜¯å¢åŠ å®ƒä»¬çš„å€¼ã€‚
<code>$(subdir-obj-y)</code> å˜é‡åˆ™æ˜¯ä» <code>$(obj-y)</code> ä¸­è¿‡æ»¤å‡ºäº†æ‰€æœ‰çš„ <code>%/built-in.a</code>ã€‚
åœ¨ <code>$(subdir-ym)</code> çš„å‘½ä»¤æ‰§è¡Œæ—¶ä¼šå»åˆ¤æ–­ <code>$(subdir-obj-y)</code> å˜é‡é‡Œæ˜¯å¦å­˜åœ¨
<code>$@/built-in.a</code>ï¼Œ å¦‚æœå­˜åœ¨è‡ªç„¶å°±ä¼šæœ‰ <code>$(builtin-target)</code> ç›®æ ‡å­˜åœ¨ã€‚ è€Œ
<code>$(builtin-target)</code> ç›®æ ‡çš„å‚æ•°æ˜¯æ‰§è¡Œäº† <code>$(call if_changed,ar_builtin)</code>ã€‚
è¿™é‡Œå°±ä¸å¾—ä¸è®²è®² <code>if_changed</code> è¿™ä¸ªä¸œè¥¿äº†ï¼Œ å®ƒåœ¨ <code>kbuild</code> ä¸­çš„å‡ºåœºç‡ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚
å®ƒçš„å®šä¹‰æ˜¯åœ¨ <code>scripts/Kbuild.include</code> ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c"># echo command.
</span></span></span><span class="line"><span class="cl"><span class="c"># Short version is used, if $(quiet) equals `quiet_&#39;, otherwise full one.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">echo-cmd</span> <span class="o">=</span> <span class="k">$(if</span> <span class="k">$($(</span>quiet<span class="k">)</span>cmd_<span class="k">$(</span>1<span class="k">))</span>,<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="nb">echo</span> <span class="s1">&#39;  $(call escsq,$($(quiet)cmd_$(1)))$(echo-why)&#39;</span><span class="p">;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># printing commands
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">cmd</span> <span class="o">=</span> @set -e<span class="p">;</span> <span class="k">$(</span>echo-cmd<span class="k">)</span> <span class="k">$(</span>cmd_<span class="k">$(</span>1<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Execute command if command has changed or prerequisite(s) are updated.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">if_changed</span> <span class="o">=</span> <span class="k">$(if</span> <span class="k">$(</span>newer-prereqs<span class="k">)$(</span>cmd-check<span class="k">)</span>,                              <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="k">$(</span>cmd<span class="k">)</span><span class="p">;</span>                                                              <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s1">&#39;cmd_$@ := $(make-cmd)&#39;</span> &gt; <span class="k">$(</span>dot-target<span class="k">)</span>.cmd, @:<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºå¦‚æœ <code>$(newer-prereqs)</code> å’Œ <code>$(cmd-check)</code> åªè¦æœ‰ä¸€ä¸ªä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ
<code>$(cmd)</code> å‘½ä»¤ï¼Œ å¦åˆ™ä¼šæ‰“å°ä¸€äº›æ—¥å¿—ã€‚ <code>$(newer-prereqs)</code> è¡¨ç¤ºä»»ä½•æ¯”ç›®æ ‡æ›´æ–°æˆ–ä¸å­˜
åœ¨çš„å…ˆå†³æ¡ä»¶ã€‚ <code>$(cmd-check)</code> çš„ä½œç”¨åˆ™æ˜¯æ£€æŸ¥ <code>$(cmd_@)</code> æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…
<code>$(cmd_@)</code> å’Œ <code>$(cmd_$(1))</code> æ˜¯å¦ç›¸ç­‰ã€‚ è¯´çš„ç®€å•ç‚¹å°±æ˜¯å»åˆ¤æ–­äº†æ˜¯å¦å­˜åœ¨æœ‰æ•ˆçš„
<code>$(cmd_$(1))</code> ç›®æ ‡ã€‚ è€Œ <code>cmd</code> ç›®æ ‡å®é™…ä¸Šåšäº†ä¸¤ä»¶äº‹ï¼š ä¸€ä¸ªæ˜¯æ‰“å°å½“å‰å‘½ä»¤ï¼Œç¬¬äºŒä¸ªæ˜¯
æ‰§è¡Œ <code>cmd_$(1)</code> å‘½ä»¤ã€‚ è¿™é‡Œçš„ <code>$(1)</code> ä¾¿æ˜¯è°ƒç”¨ <code>if_changed</code> æ—¶ä¼ å…¥çš„å‚æ•°ã€‚ æ‰€ä»¥
<code>$(builtin-target)</code> ç›®æ ‡çš„å‘½ä»¤å°±æ˜¯å»æ‰§è¡Œ <code>cmd_ar_builtin</code> ç›®æ ‡ã€‚ è€Œå®ƒçš„å®šä¹‰æ˜¯è¿™
æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nv">cmd_ar_builtin</span> <span class="o">=</span> rm -f <span class="nv">$@</span><span class="p">;</span> <span class="k">$(</span>AR<span class="k">)</span> cDPrST <span class="nv">$@</span> <span class="k">$(</span>real-prereqs<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œ <code>cmd_ar_builtin</code> å‘½ä»¤å°±æ˜¯å°†å½“å‰ç›®å½•ä¸‹çš„ç¼–è¯‘ç›®æ ‡ä»¬éƒ½ç”¨ <code>$(AR)</code> å‘½
ä»¤æ‰“åŒ…æˆ <code>$(builtin-target)</code>ï¼Œ ä¹Ÿå°±æ˜¯ <code>$(obj)/built-in.a</code>ã€‚ è¿™å°±æ˜¯åœ¨å›¾ä¸­å„ä¸ªç¨‹åº
æ¨¡å—ç›®å½•ä¸‹ <code>built-in.a</code> çš„æ¥æºã€‚</p>
<h4 id="autoksyms_recursive">autoksyms_recursive</h4>
<p>è¿™éƒ¨åˆ†ä»çš„åŠŸèƒ½ä»å›¾ä¸­çœ‹æ˜¯è¢«åˆ†æˆäº†ä¸¤ä¸ªåˆ†æ”¯ï¼š</p>
<p><code>descend</code> ä¾èµ–çš„ <code>prepare</code> ä¸»è¦æ˜¯å»åšäº†ä¸€äº›ç¼–è¯‘å‰çš„å‡†å¤‡å·¥ä½œã€‚ ä¾‹å¦‚
<code>outputmakefile</code> æ˜¯å»ç¼–è¯‘è¾“å‡ºç›®å½•ç”Ÿæˆä¸€ä¸ª <code>Makefile</code>ç­‰ã€‚</p>
<p><code>modules.order</code> ç›®æ ‡çš„å‘½ä»¤æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="k">$(</span><span class="nv">Q</span><span class="k">)$(</span><span class="nv">AWK</span><span class="k">)</span> <span class="s1">&#39;!x[$$0]++&#39;</span> <span class="k">$(</span><span class="nv">addsuffix</span> /<span class="k">$</span>@, <span class="k">$(</span><span class="nv">build</span>-<span class="nv">dirs</span><span class="k">))</span> <span class="err">&gt;</span> <span class="k">$@</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒä¸»è¦æ˜¯ç”Ÿæˆäº† <code>modules.order</code> æ–‡ä»¶ã€‚ è¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æ¥è®°å½•ç¼–è¯‘çš„å¤–éƒ¨æ¨¡å—ï¼Œ ç›®çš„æ˜¯
ç»™ <code>modprobe</code> å‘½ä»¤åŠ å¸è½½æ¨¡å—æ—¶ä½¿ç”¨ã€‚</p>
<p>è€Œ <code>autoksyms_recursive</code> ç›®æ ‡çš„å‘½ä»¤æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">CONFIG_TRIM_UNUSED_KSYMS</span>
</span></span><span class="line"><span class="cl"><span class="nf">autoksyms_recursive</span><span class="o">:</span> <span class="n">descend</span> <span class="n">modules</span>.<span class="n">order</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>CONFIG_SHELL<span class="k">)</span> <span class="k">$(</span>srctree<span class="k">)</span>/scripts/adjust_autoksyms.sh <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  <span class="s2">&#34;</span><span class="k">$(</span>MAKE<span class="k">)</span><span class="s2"> -f </span><span class="k">$(</span>srctree<span class="k">)</span><span class="s2">/Makefile vmlinux&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œçš„ <code>CONFIG_TRIM_UNUSED_KSYMS</code> é»˜è®¤æ˜¯æ²¡æœ‰è¢«å®šä¹‰çš„ï¼Œ æ‰€ä»¥åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™é‡Œçš„
å‘½ä»¤ä¹Ÿå°±ä¸ä¼šè¢«æ‰§è¡Œã€‚ å‘½ä»¤ä¸­çš„ <code>$(CONFIG_SHELL)</code> åœ¨ <code>kbuild</code> ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œ
å®ƒçš„å€¼åœ¨é¡¶å±‚ <code>Makefile</code>ä¸­è¢«å®šä¹‰æˆäº† <code>CONFIG_SHELL := sh</code>ã€‚ æ‰€ä»¥å®ƒçš„ä½œç”¨å°±æ˜¯ç¡®å®š
äº† <code>kbuild</code> æ‰€ä½¿ç”¨çš„ <code>SHELL</code>ã€‚ æ‰€ä»¥ä¸Šé¢çš„å‘½ä»¤å…¶å®å°±æ˜¯å»æ‰§è¡Œäº†
<code>scripts/adjust_autoksyms.sh</code> è„šæœ¬ã€‚ è€Œè¿™ä¸ªè„šæœ¬çš„ä½œç”¨åœ¨è„šæœ¬å¼€å¤´çš„æ³¨é‡Šä¸­ä¹Ÿæœ‰ä»‹ç»ï¼š</p>
<pre><code># Create/update the include/generated/autoksyms.h file from the list
 # of all module's needed symbols as recorded on the second line of *.mod files.

 # For each symbol being added or removed, the corresponding dependency
 # file's timestamp is updated to force a rebuild of the affected source
 # file. All arguments passed to this script are assumed to be a command
 # to be exec'd to trigger a rebuild of those files.
</code></pre>
<p>è¯´ç®€å•ç‚¹å°±æ˜¯ç”Ÿæˆæˆ–è€…æ›´æ–° <code>include/generated/autoksyms.h</code> å’Œå…¶ä»–ä¾èµ–æ–‡ä»¶ã€‚ æ‰€ä»¥ç»¼
åˆæ¥çœ‹è¿™éƒ¨åˆ†çš„å†…å®¹ä¸»è¦æ˜¯åšå¥½ç¼–è¯‘å‰çš„å‡†å¤‡å·¥ä½œã€‚</p>
<h4 id="scriptslink-vmlinuxsh">scripts/link-vmlinux.sh</h4>
<p>è¿™ä¸ªè„šæœ¬çš„ä½œç”¨æ˜¯ç”¨äºé“¾æ¥ç”Ÿæˆæœ€ç»ˆçš„ <code>vmlinux</code> ç›®æ ‡çš„ã€‚ åŒæ ·çš„ï¼Œ è¿™ä¸ªè„šæœ¬å¼€å¤´çš„æ³¨
é‡Šæˆ‘è§‰å¾—è®²çš„æ¯”è¾ƒæ¸…æ¥šï¼Œ ä¹Ÿéå¸¸çš„æœ‰æ„ä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Text" data-lang="Text"><span class="line"><span class="cl"># vmlinux is linked from the objects selected by $(KBUILD_VMLINUX_OBJS) and
</span></span><span class="line"><span class="cl"># $(KBUILD_VMLINUX_LIBS). Most are built-in.a files from top-level directories
</span></span><span class="line"><span class="cl"># in the kernel tree, others are specified in arch/$(ARCH)/Makefile.
</span></span><span class="line"><span class="cl"># $(KBUILD_VMLINUX_LIBS) are archives which are linked conditionally
</span></span><span class="line"><span class="cl"># (not within --whole-archive), and do not require symbol indexes added.
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># vmlinux
</span></span><span class="line"><span class="cl">#   ^
</span></span><span class="line"><span class="cl">#   |
</span></span><span class="line"><span class="cl">#   +--&lt; $(KBUILD_VMLINUX_OBJS)
</span></span><span class="line"><span class="cl">#   |    +--&lt; init/built-in.a drivers/built-in.a mm/built-in.a + more
</span></span><span class="line"><span class="cl">#   |
</span></span><span class="line"><span class="cl">#   +--&lt; $(KBUILD_VMLINUX_LIBS)
</span></span><span class="line"><span class="cl">#   |    +--&lt; lib/lib.a + more
</span></span><span class="line"><span class="cl">#   |
</span></span><span class="line"><span class="cl">#   +-&lt; ${kallsymso} (see description in KALLSYMS section)
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># vmlinux version (uname -v) cannot be updated during normal
</span></span><span class="line"><span class="cl"># descending-into-subdirs phase since we do not yet know if we need to
</span></span><span class="line"><span class="cl"># update vmlinux.
</span></span><span class="line"><span class="cl"># Therefore this step is delayed until just before final link of vmlinux.
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># System.map is generated to document addresses of all kernel symbols
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ„å»ºçš„ç›®æ ‡">æ„å»ºçš„ç›®æ ‡</h3>
<p>è™½ç„¶åœ¨ä¸Šé¢çš„è®²è¿°ä¸­ä¸€ç›´æ˜¯ä»¥ <code>vmlinux</code> å½“ä½œæœ€ç»ˆç›®æ ‡æ¥è®²çš„ï¼Œ ä½†æ˜¯å®é™…ä¸Šå¦‚æœæˆ‘ä»¬åœ¨ç¼–
è¯‘å†…æ ¸æ—¶è¾“å…¥ <code>make</code> æ—¶æ²¡æœ‰æŒ‡å®šä»»ä½•ç›®æ ‡æ—¶ï¼Œ é»˜è®¤ç›®æ ‡ <code>all</code> ä¼šä½¿ç”¨
<code>arch/$(ARCH)/Makefile</code> æ–‡ä»¶ä¸­å®šä¹‰çš„å€¼ã€‚ åœ¨ <code>x86</code> å¹³å°ä¸Šæ˜¯è¿™æ ·å®šä¹‰çš„: <code>all: bzImage</code>ã€‚ é‚£è¿™é‡Œå°±æ¥è¯´è¯´ <code>vmlinux</code> å’Œ <code>bzImage</code> ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><code>vmlinux</code> åªæ˜¯ç¼–è¯‘å‡ºæ¥çš„æœ€åŸå§‹çš„å†…æ ¸æ–‡ä»¶ï¼Œ å®ƒçš„æœ¬è´¨æ˜¯ä¸€ä¸ªåŒ…å«é™æ€é“¾æ¥ï¼Œå¸¦è°ƒè¯•ä¿¡
æ¯çš„ <code>ELF</code> æ–‡ä»¶ï¼Œ ä¸å¸¦æœ‰å¼•å¯¼ä¿¡æ¯ã€‚ è€Œæœ‰äº›æ—¶å€™ï¼Œå°¤å…¶æ˜¯åœ¨åµŒå…¥å¼ <code>ARM</code> å¤„ç†å™¨ä¸Šæˆ‘ä»¬
éœ€è¦çš„æ˜¯ä¸€ä¸ªå¯è¢«å¼•å¯¼çš„å†…æ ¸é•œåƒï¼Œ è€Œ <code>bzImage</code> å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªç›®æ ‡ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ åˆ›
å»ºä¸€ä¸ªå¯å¼•å¯¼çš„å†…æ ¸é•œåƒæ—¶ï¼Œ è¿™ä¸ªé•œåƒéƒ½ä¼šå…ˆç»è¿‡å‹ç¼©å¤„ç†ï¼Œ è€Œåœ¨åˆ›å»ºå¥½çš„é•œåƒçš„å¼€å¤´ä¼š
åµŒæœ‰è§£å‹ä»£ç ï¼Œ è¿™é‡Œçš„ <code>bzImage</code> æ–‡ä»¶ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚ å®ƒæ˜¯ç»è¿‡äº† <code>gzip</code> å’Œ <code>objcopy</code>
å·¥å…·åˆ¶ä½œå‡ºæ¥çš„å‹ç¼©æ–‡ä»¶ã€‚ ä¸ä»…å¦‚æ­¤ï¼Œ <code>bzImage</code> æ–‡ä»¶è¿˜åŒ…å«äº† <code>bootsect.o</code>ï¼Œ
<code>setup.o</code>ï¼Œ <code>misc.o</code>ï¼Œ <code>piggy.o</code> ç­‰å†…å®¹ã€‚</p>
<h2 id="ç»“è¯­">ç»“è¯­</h2>
<p>å…³äº <code>kbuild</code> ç³»ç»Ÿå°±åˆ†æåˆ°è¿™é‡Œäº†ï¼Œ ä¸‹é¢å’Œå¤§å®¶åˆ†äº«ä¸€ç‚¹æˆ‘çš„æ„Ÿæƒ³ã€‚</p>
<p>ä»ä¸Šé¢çš„è®²è§£è¿‡ç¨‹ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ æˆ‘å¼•ç”¨äº†å¾ˆå¤šå†…æ ¸é‡Œçš„æ–‡æ¡£å’Œæ³¨é‡Šã€‚ ä¸å¾—ä¸è¯´ï¼Œ å†…æ ¸çš„
æ–‡æ¡£å’Œæ³¨é‡ŠçœŸçš„éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚ ä»æ–‡æ¡£å’Œæ³¨é‡Šçš„å†…å®¹ä¸Šæ¥è¯´ï¼Œ å®ƒä»¬å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½
æ›´å¿«çš„ç†è§£å†…æ ¸ä¸­çš„å†…å®¹ï¼Œ ä»ç¼–ç¨‹çš„æ–¹é¢æ¥è¯´æˆ‘ä»¬å¹³æ—¶å†™ç¨‹åºçš„æ—¶å€™å†™æ–‡æ¡£å†™æ³¨é‡Šä¹Ÿåº”è¯¥
å‘å†…æ ¸ä¸­çš„æ–‡æ¡£æ³¨é‡Šå­¦ä¹ , å³ç®€å•æ˜äº†åˆèƒ½æŠ“ä½é‡ç‚¹ç†æ¸…é€»è¾‘ã€‚ å½“ç„¶ï¼Œ ä¸æ­¢æ˜¯æ–‡æ¡£å’Œæ³¨é‡Šï¼Œ
<code>GNU Linux</code> çš„å†…æ ¸ä¸­å¤„å¤„éƒ½æœ‰å€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„åœ°æ–¹, å®›å¦‚ä¸€ä¸ªå®è—ã€‚</p>
<p>æœ€åï¼Œ å¦‚æœå¤§å®¶å‘ç°æ–‡ç« ä¸­æœ‰ä»€ä¹ˆé”™è¯¯æˆ–è€…ç–‘é—®ï¼Œ æ¬¢è¿ç•™è¨€ä¸€èµ·äº¤æµã€‚</p>
<hr>
<p><strong>Happy Hacking!</strong></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æœ¬æ–‡äº 2020-05-02 æ›´æ–°&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/60773f0ad162c04203e7a58be05fc8344ce67e19" target="_blank" title="commit by yunyanan(yunyanan1@gmail.com) 60773f0ad162c04203e7a58be05fc8344ce67e19: update LoveIt theme">
                                <i class="fas fa-hashtag fa-fw"></i>60773f0</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/exploring_kbuild/index.md" target="_blank">é˜…è¯»åŸå§‹æ–‡æ¡£</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://yunyanan.github.io/exploring_kbuild/" data-title="å†…æ ¸ç¼–è¯‘çš„èƒŒå" data-hashtags="Linux,Kernel,Kbuild,Makefile,Kconfig"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Facebook" data-sharer="facebook" data-url="https://yunyanan.github.io/exploring_kbuild/" data-hashtag="Linux"><i class="fab fa-facebook-square fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/linux/">Linux</a>,&nbsp;<a href="/tags/kernel/">Kernel</a>,&nbsp;<a href="/tags/kbuild/">Kbuild</a>,&nbsp;<a href="/tags/makefile/">Makefile</a>,&nbsp;<a href="/tags/kconfig/">Kconfig</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/linux_kernel_compile/" class="prev" rel="prev" title="ç¼–è¯‘ Linux å†…æ ¸"><i class="fas fa-angle-left fa-fw"></i>ç¼–è¯‘ Linux å†…æ ¸</a>
            <a href="/devicetree/" class="next" rel="next" title="DeviceTree">DeviceTree<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.93.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.4"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">YunYanan</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><script type="text/javascript">
    window.config = {"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"valine":{"appId":"Rf1OExncyuF63xO6zVHaqdrm-gzGzoHsz","appKey":"uIrFaPMGG1RgVwNJdrX1TTxa","avatar":"mp","el":"#valine","enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"Hi ^_^","recordIP":true,"visitor":true}},"headerMode":{"desktop":"fixed","mobile":"auto"}};
</script><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=Element.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2CPromise%2CObject.entries%2CObject.assign%2CObject.values%2Cfetch%2CElement.prototype.after%2CArray.prototype.fill%2CIntersectionObserver%2CArray.from%2CArray.prototype.find%2CMath.sign"></script><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/object-fit-images/ofi.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
