<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>内核编译的背后 - YunYanan</title>
        <meta name="Description" content="个人博客"><meta property="og:title" content="内核编译的背后" />
<meta property="og:description" content="


Hey, 会编译内核了之后还想知道内核编译背后的 Kbuild 吗 😏" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yunyanan.github.io/exploring_kbuild/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-15T10:29:35+08:00" />
<meta property="article:modified_time" content="2020-05-02T19:46:37+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="内核编译的背后"/>
<meta name="twitter:description" content="


Hey, 会编译内核了之后还想知道内核编译背后的 Kbuild 吗 😏"/>
<meta name="application-name" content="YunYanan">
<meta name="apple-mobile-web-app-title" content="YunYanan"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://yunyanan.github.io/exploring_kbuild/" /><link rel="prev" href="https://yunyanan.github.io/linux_kernel_compile/" /><link rel="next" href="https://yunyanan.github.io/devicetree/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "内核编译的背后",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/yunyanan.github.io\/exploring_kbuild\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/yunyanan.github.io\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "Linux, Kernel, Kbuild, Makefile, Kconfig","wordcount":  1919 ,
        "url": "https:\/\/yunyanan.github.io\/exploring_kbuild\/","datePublished": "2020-03-15T10:29:35+08:00","dateModified": "2020-05-02T19:46:37+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "xxxx",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/yunyanan.github.io\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"author": {
                "@type": "Person",
                "name": "YunYanan"
            },"description": ""
    }
    </script></head>
    <body><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="YunYanan"><span class="header-title-pre"><i class='far fa-paper-plane fa-fw'></i> </span>YunYanan</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="YunYanan"><span class="header-title-pre"><i class='far fa-paper-plane fa-fw'></i> </span>YunYanan</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">内核编译的背后</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>YunYanan</a></span>&nbsp;
                    <span class="post-category">收录于<a href="/categories/linux/">
                                <i class="far fa-folder fa-fw"></i>Linux
                            </a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-03-15>2020-03-15</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>约 1919 字&nbsp;
                <i class="far fa-clock fa-fw"></i>预计阅读 10 分钟&nbsp;<span id="/exploring_kbuild/" class="leancloud_visitors" data-flag-title="内核编译的背后">
                        <i class="far fa-eye fa-fw"></i><span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#kbuild--kconfig">Kbuild &amp;&amp; Kconfig</a>
      <ul>
        <li><a href="#make-config-的背后">make *config 的背后</a>
          <ul>
            <li><a href="#outputmakefile">outputmakefile</a></li>
            <li><a href="#scripts_basic">scripts_basic</a></li>
            <li><a href="#force">FORCE</a></li>
            <li><a href="#config-目标的命令">%config 目标的命令</a></li>
          </ul>
        </li>
        <li><a href="#vmlinux-生成的背后">vmlinux 生成的背后</a>
          <ul>
            <li><a href="#vmlinux-deps">$(vmlinux-deps)</a></li>
            <li><a href="#autoksyms_recursive">autoksyms_recursive</a></li>
            <li><a href="#scriptslink-vmlinuxsh">scripts/link-vmlinux.sh</a></li>
          </ul>
        </li>
        <li><a href="#构建的目标">构建的目标</a></li>
      </ul>
    </li>
    <li><a href="#结语">结语</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div style="text-align: center">
<img src="/images/posts/exploring_kbuild/kbuild.png"/>
</div>
<p>Hey, 会编译内核了之后还想知道内核编译背后的 <code>Kbuild</code> 吗 😏</p>
<h2 id="前言">前言</h2>
<hr>
<p>最近了解 <strong>Kbuild</strong> 的时候, 在网上搜索相关的内容发现讲这方面内容的文章比起教你怎
么编译内核的文章数量上要少很多。 我觉得这也反应出 <strong>Kbuild</strong> 系统确实是容易被忽
视的一隅， 也说明了会编译内核的人不再少数，但是去研究过 <strong>Kbuild</strong> 系统的， 对
<strong>Kbuild</strong> 感兴趣的人则要少很大一部分。 下面呢来讲讲我对 <strong>Kbuild</strong> 的理解。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>注意<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ul>
<li>本文中是以在 PC 上编译 <code>GNU Linux</code> 内核为例。</li>
<li>本文研究使用的内核版本信息如下：
<blockquote>
<p>VERSION = 5	<br>
PATCHLEVEL = 6 <br>
SUBLEVEL = 0	<br>
EXTRAVERSION = -rc3	<br>
NAME = Kleptomaniac Octopus</p>
</blockquote>
</li>
</ul>
</div>
        </div>
    </div>
<h2 id="kbuild--kconfig">Kbuild &amp;&amp; Kconfig</h2>
<hr>
<p>刚开始接触 <strong>GNU Linux</strong> 内核的时候我就知道在内核中有一系列的 <strong>Kconfig</strong> 和
<strong>Makefile</strong> 文件， 内核源码的很多目录下也都是一个 <strong>Kconfig</strong> 文件搭配一个
<strong>Makefile</strong> 文件。我知道 <strong>Kbuild</strong> 这个名词的时候是很久之后了。 当看到这个词的
时候我的第一反应是觉得 <strong>&ldquo;Kbuild&rdquo;</strong> 它是内核中具体的某个配置文件或者编译脚本之类
的东西。 网上一众文章中也很少有直接给 <strong>Kbuild</strong> 下一个定义， 我在官方的
<a href="https://www.kernel.org/doc/Documentation/kbuild/modules.txt" target="_blank" rel="noopener noreffer">内核文档 modules 篇</a>
中找到这样的一句话， 也算是通俗易懂的介绍了 <strong>kbuild</strong>：</p>
<blockquote>
<p>&ldquo;kbuild&rdquo; is the build system used by the Linux kernel.</p>
</blockquote>
<p>这里定义的 <strong>Kbuild</strong> 是从广义上来说的 <strong>Kbuild</strong>。 而内核中也存在一些名字就是
<strong>Kbuild</strong> 的文件， 那这些文件是什么呢？ 这其实有个有趣的地方， 在
<a href="https://www.kernel.org/doc/Documentation/kbuild/makefiles.txt" target="_blank" rel="noopener noreffer">内核文档 makefiles 篇</a>
中的第三节有这样的一个介绍：</p>
<blockquote>
<p>&ldquo;Most Makefiles within the kernel are kbuild Makefiles that use the kbuild
infrastructure. This chapter introduces the syntax used in the kbuild
makefiles. The preferred name for the kbuild files are &lsquo;Makefile&rsquo; but
&lsquo;Kbuild&rsquo; can be used and if both a &lsquo;Makefile&rsquo; and a &lsquo;Kbuild&rsquo; file exists,
then the &lsquo;Kbuild&rsquo; file will be used.&rdquo;</p>
</blockquote>
<p>所以说我上面提到的我的第一感觉也不能算错， 从狭义上讲 <strong>Kbuild</strong> 也可以指内核中的编
译脚本， 只不过官方更推荐使用 <strong>&ldquo;Makefile&rdquo;</strong> 这个名字。</p>
<p>关于 <strong>Kconfig</strong>， 这里其实不用更多的解释了，它就是指内核的配置，没有歧义。网上好多
文章把 <strong>Kconfig</strong> 和 Kbuild 是以并列的架构讲解的， 而内核中关于 <strong>Kconfig</strong> 描
述文档则全部都归类在 <strong>Kbuild</strong> 下的。 这其实也是从 广义还是狭义上来看待
<strong>Kbuild</strong> 的问题了。</p>
<p>构建内核的第一步始终是配置内核。 在上一篇文章中也讲了如何配置内核， 这里就先来看看
在 <code>menuconfig</code>, <code>xconfig</code> 等这些配置方式的背后到底发生了什么。</p>
<h3 id="make-config-的背后">make *config 的背后</h3>
<hr>
<p>当我们执行 <code>make menuconfig</code> 或 <code>make xconfig</code> 等命令时， 匹配到的是顶层
<strong>Makefile</strong> 中的 <code>%config</code> 目标：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nf">%config</span><span class="o">:</span> <span class="n">outputmakefile</span> <span class="n">scripts_basic</span> <span class="n">FORCE</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span>scripts/kconfig <span class="nv">$@</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>它有三个依赖： <code>outputmakefile</code>, <code>scripts_basic</code>, <code>FORCE</code> 以及一条命令。 我们一个一个来看。</p>
<h4 id="outputmakefile">outputmakefile</h4>
<p>我把 outputmakefile 目标的来源以及它所依赖的一些变量来源从顶层 Makefile 中拿
出来放在了一起：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c">#####################
</span></span></span><span class="line"><span class="cl"><span class="c"># abs_objtree 变量来源
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifeq</span> <span class="err">(</span><span class="s2">&#34;$(origin O)&#34;</span><span class="err">,</span> <span class="s2">&#34;command line&#34;</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">KBUILD_OUTPUT</span> <span class="o">:=</span> <span class="k">$(</span>O<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifneq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">KBUILD_OUTPUT</span><span class="k">)</span><span class="err">,)</span>
</span></span><span class="line"><span class="cl"><span class="c"># Make&#39;s built-in functions such as $(abspath ...), $(realpath ...) cannot
</span></span></span><span class="line"><span class="cl"><span class="c"># expand a shell special character &#39;~&#39;. We use a somewhat tedious way here.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">abs_objtree</span> <span class="o">:=</span> <span class="k">$(</span>shell mkdir -p <span class="k">$(</span>KBUILD_OUTPUT<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="k">$(</span>KBUILD_OUTPUT<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">$(</span><span class="nv">if</span> <span class="k">$(</span><span class="nv">abs_objtree</span><span class="k">)</span>,, \
</span></span><span class="line"><span class="cl">     <span class="k">$(</span><span class="nv">error</span> <span class="nv">failed</span> <span class="nv">to</span> <span class="nv">create</span> <span class="nv">output</span> <span class="nv">directory</span> &#34;<span class="k">$(</span><span class="nv">KBUILD_OUTPUT</span><span class="k">)</span>&#34;<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># $(realpath ...) resolves symlinks
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">abs_objtree</span> <span class="o">:=</span> <span class="k">$(</span>realpath <span class="k">$(</span>abs_objtree<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl"><span class="nv">abs_objtree</span> <span class="o">:=</span> <span class="k">$(</span>CURDIR<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span> <span class="c"># ifneq ($(KBUILD_OUTPUT),)
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="c">#####################
</span></span></span><span class="line"><span class="cl"><span class="c"># abs_srctree 变量来源
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="nv">abs_srctree</span> <span class="o">:=</span> <span class="k">$(</span>realpath <span class="k">$(</span>dir <span class="k">$(</span>lastword <span class="k">$(</span>MAKEFILE_LIST<span class="k">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">################################
</span></span></span><span class="line"><span class="cl"><span class="c"># building_out_of_srctree 变量来源
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">abs_srctree</span><span class="k">)</span><span class="err">,</span><span class="k">$(</span><span class="nv">abs_objtree</span><span class="k">)</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">        <span class="c"># building in the source tree
</span></span></span><span class="line"><span class="cl"><span class="c"></span>        srctree :<span class="o">=</span> .
</span></span><span class="line"><span class="cl">	building_out_of_srctree :<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl">        <span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">abs_srctree</span><span class="k">)</span><span class="err">/,</span><span class="k">$(</span><span class="nv">dir</span> <span class="k">$(</span><span class="nv">abs_objtree</span><span class="k">))</span><span class="err">)</span>
</span></span><span class="line"><span class="cl">                <span class="c"># building in a subdirectory of the source tree
</span></span></span><span class="line"><span class="cl"><span class="c"></span>                srctree :<span class="o">=</span> ..
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                srctree :<span class="o">=</span> <span class="k">$(</span>abs_srctree<span class="k">)</span>
</span></span><span class="line"><span class="cl">        endif
</span></span><span class="line"><span class="cl">	building_out_of_srctree :<span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#####################
</span></span></span><span class="line"><span class="cl"><span class="c"># outputmakefile 目标
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="nf">outputmakefile</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">building_out_of_srctree</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)</span><span class="err">if</span> <span class="err">[</span> <span class="err">-f</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/.config</span> <span class="err">-o</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		 <span class="err">-d</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/include/config</span> <span class="err">-o</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		 <span class="err">-d</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/arch/</span><span class="k">$(</span><span class="nv">SRCARCH</span><span class="k">)</span><span class="err">/include/generated</span> <span class="err">];</span> <span class="err">then</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;***&#34;</span><span class="err">;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;*** The source tree is not clean, please run &#39;make$(if $(findstring command line, $(origin ARCH)), ARCH=$(ARCH)) mrproper&#39;&#34;</span><span class="err">;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;*** in $(abs_srctree)&#34;</span><span class="err">;\</span>
</span></span><span class="line"><span class="cl">		<span class="err">echo</span> <span class="err">&gt;&amp;2</span> <span class="s2">&#34;***&#34;</span><span class="err">;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">		<span class="err">false;</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">	<span class="err">fi</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)</span><span class="err">ln</span> <span class="err">-fsn</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span> <span class="err">source</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)$(</span><span class="nv">CONFIG_SHELL</span><span class="k">)</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/scripts/mkmakefile</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span><span class="nv">Q</span><span class="k">)</span><span class="err">test</span> <span class="err">-e</span> <span class="err">.gitignore</span> <span class="err">||</span> <span class="err">\</span>
</span></span><span class="line"><span class="cl">	<span class="err">{</span> <span class="err">echo</span> <span class="s2">&#34;# this is build directory, ignore it&#34;</span><span class="err">;</span> <span class="err">echo</span> <span class="s2">&#34;*&#34;</span><span class="err">;</span> <span class="err">}</span> <span class="err">&gt;</span> <span class="err">.gitignore</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们从下往上看， <code>outputmakefile</code> 目标的内容是否有效取决于这样的一个依赖关系链：</p>
<pre><code>outputmakefile --&gt; building_out_of_srctree --&gt; abs_srctree, abs_objtree
</code></pre>
<ul>
<li>
<p><code>abs_objtree</code> 取决于命令行是否有 <code>O=DIR</code> 参数传入。 <strong>DIR</strong> 表示编译输出文件的
存放路径， 默认是在源码路径下。 如果有这个参数传入则 <code>abs_objtree</code> 的值为传入
的路径，否则为源码路径。</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>注意<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">当指定了 <code>O=DIR</code> 参数的时候 <strong>Makefile</strong> 不仅会去创建这个目录，并且会将工作路
径切换到 <strong>DIR</strong> 这个路径去。</div>
        </div>
    </div>
</li>
<li>
<p><code>abs_srctree</code> 是由 <code>MAKEFILE_LIST</code> 变量经过 <code>lastword</code>, <code>dir</code>, <code>realpath</code> 几个函
数处理后得到的结果，最后的结果是顶层 <strong>Makefile</strong> 的绝对路径。</p>
</li>
<li>
<p><code>building_out_of_srctree</code> 的值则取决于 <code>abs_objtree</code> 和 <code>abs_srctree</code> 是否相等，
不相等时 <code>building_out_of_srctree</code> 的值为 1， 否则为空。</p>
</li>
<li>
<p>到这里其实可以看得出 <code>outputmakefile</code> 这个目标是为 <code>O=DIR</code> 这个参数服务的。 它真正
做了这么两件事：</p>
<ol>
<li>在 <strong>DIR</strong> 路径下创建了源码目录的软链接。</li>
<li>执行了 <code>$(srctree)/scripts/mkmakefile $(srctree)</code> 这条 <strong>shell</strong> 命令。</li>
</ol>
<p>关键在于第二条， 这条命令是去执行源码路径下的 <code>scripts/mkmakefile</code> 脚本，并且将
源码路径作为参数传入。而这个脚本的内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF &gt; Makefile
</span></span></span><span class="line"><span class="cl"><span class="s"># Automatically generated by $0: don&#39;t edit
</span></span></span><span class="line"><span class="cl"><span class="s">include $1/Makefile
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，它的作用就是在 <strong>DIR</strong> 路径下创建出一个 <strong>Makefile</strong> 文件并包含源码目录下的顶
层 <strong>Makefile</strong>。</p>
</li>
</ul>
<h4 id="scripts_basic">scripts_basic</h4>
<p><code>scripts_basic</code> 目标的内容是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nf">scripts_basic</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span>scripts/basic
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)</span>rm -f .tmp_quiet_recordmcount
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>信息<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">变量 <code>$(Q)</code> 是定义在顶层 <strong>Makefile</strong> 中的， 它的作用是编译时控制 <strong>Makefile</strong>
否要回显命令。 它的值取决于命令行有没有 <code>V=1</code> 的参数传入，如果有这个参数传入，
<code>$(Q)</code> 的值为空， 否则为 <code>@</code>。 在这里分析 <strong>Makefile</strong> 时都可以先忽略它。</div>
        </div>
    </div>
<p>这里面比较麻烦的是 <code>build</code> 这个变量，其实它是定义在了 <strong>&ldquo;scripts/Kbuild.include&rdquo;</strong>
中。 它的定义是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c">###
</span></span></span><span class="line"><span class="cl"><span class="c"># Shorthand for $(Q)$(MAKE) -f scripts/Makefile.build obj=
</span></span></span><span class="line"><span class="cl"><span class="c"># Usage:
</span></span></span><span class="line"><span class="cl"><span class="c"># $(Q)$(MAKE) $(build)=dir
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">build</span> <span class="o">:=</span> -f <span class="k">$(</span>srctree<span class="k">)</span>/scripts/Makefile.build obj
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里注释也解释了为什么把它定义成这样和怎么使用它。而 <code>MAKE</code> 变量是 <code>GNU make</code> 定义
的变量，一般它的值都是 <code>make</code>， 有关它的详细介绍可以参考
<a href="https://www.gnu.org/software/make/manual/html_node/MAKE-Variable.html" target="_blank" rel="noopener noreffer">这里</a>。
所以上面 <code>$(Q)$(MAKE) $(build)=scripts/basic</code> 这条规则可以展开成这样：
<code>make -f $(srctree)/scripts/Makefile.build obj=scripts/basic</code>。
这里没有指定目标，所以编译的是 <code>Makefile.build</code> 的默认目标：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nf">__build</span><span class="o">:</span> <span class="k">$(</span><span class="nv">if</span> <span class="k">$(</span><span class="nv">KBUILD_BUILTIN</span><span class="k">)</span>,<span class="k">$(</span><span class="nv">builtin</span>-<span class="nv">target</span><span class="k">)</span> <span class="k">$(</span><span class="nv">lib</span>-<span class="nv">target</span><span class="k">)</span> <span class="k">$(</span><span class="nv">extra</span>-<span class="nv">y</span><span class="k">))</span> \
</span></span><span class="line"><span class="cl">	 <span class="k">$(</span><span class="nv">if</span> <span class="k">$(</span><span class="nv">KBUILD_MODULES</span><span class="k">)</span>,<span class="k">$(</span><span class="nv">obj</span>-<span class="nv">m</span><span class="k">)</span> <span class="k">$(</span><span class="nv">mod</span>-<span class="nv">targets</span><span class="k">)</span> <span class="k">$(</span><span class="nv">modorder</span>-<span class="nv">target</span><span class="k">))</span> \
</span></span><span class="line"><span class="cl">	 <span class="k">$(</span><span class="nv">subdir</span>-<span class="nv">ym</span><span class="k">)</span> <span class="k">$(</span><span class="nv">always</span>-<span class="nv">y</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">	@:
</span></span></code></pre></td></tr></table>
</div>
</div><p>当配置内核时， <strong>$(KBUILD_BUILTIN)</strong>， <strong>$(KBUILD_MODULES)</strong>， <strong>$(subdir-ym)</strong> 的值都为空， 所以
只有 <strong>$(always-y)</strong> 目标有效, 此时 <strong>$(always-y)</strong> 的值为 <code>fixdep</code>。
所以 <code>scripts_basic</code> 这个目标其实是去编译了 <code>scripts/basic</code> 下的源码生成 <code>fixdep</code> 工具。</p>
<p>关于 <strong>fixdep</strong> 工具的作用在 <code>scripts/basic/Makefile</code> 里有一段这样的解释：</p>
<blockquote>
<p>fixdep: used to generate dependency information during build process</p>
</blockquote>
<p>在这里就不对 <strong>fixdep</strong> 工具展开详细分析了。</p>
<h4 id="force">FORCE</h4>
<p><code>FORCE</code> 目标是定义在顶层 <strong>Makefile</strong> 的最后：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nv">PHONY</span> <span class="o">+=</span> FORCE
</span></span><span class="line"><span class="cl"><span class="nf">FORCE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Declare the contents of the PHONY variable as phony.  We keep that
</span></span></span><span class="line"><span class="cl"><span class="c"># information in a variable so we can use it in if_changed and friends.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nf">.PHONY</span><span class="o">:</span> <span class="k">$(</span><span class="nv">PHONY</span><span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里其实也是一个比较有意思的地方， 在 <strong>Makefile</strong> 中 <code>FORCE</code> 目标并没有依赖，
也没有要执行的命令， 但是 <code>FORCE</code> 目标的使用却不止一处两处。 那么为什么要这么用
呢？ 这个答案其实 <code>GNU Make</code> 官方就已经给出了：</p>
<blockquote>
<p>If a rule has no prerequisites or recipe, and the target of the rule is a
nonexistent file, then make imagines this target to have been updated whenever
its rule is run. This implies that all targets depending on this one will
always have their recipe run.</p>
</blockquote>
<p>简而言之就是这样定义出的 <code>FORCE</code> 目标在使用时其实可以把它当成一个关键字， 如果依
赖中加上 <code>FORCE</code> 的话, <strong>make</strong> 工具便会认为这个目标的依赖更新过， 需要重新生成
这个目标。 详细内容可以参考 <code>GNU Make</code>
<a href="https://www.gnu.org/software/make/manual/html_node/Force-Targets.html" target="_blank" rel="noopener noreffer">官方手册</a>。</p>
<h4 id="config-目标的命令">%config 目标的命令</h4>
<p><code>%config</code> 的命令原本是这样的： <code>$(Q)$(MAKE) $(build)=scripts/kconfig $@</code>。 这条
命令展开后就变成了这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="err">make</span> <span class="err">-f</span> <span class="k">$(</span><span class="nv">srctree</span><span class="k">)</span><span class="err">/scripts/Makefile.build</span> <span class="nv">obj</span><span class="o">=</span>scripts/kconfig %config
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出， 它又去调用了 <code>scripts/Makefile.build</code> 文件， 只不过此时有参数
<code>obj=scripts/kconfig</code>， 有目标 <code>%config</code>。</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>信息<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">这里目标 <code>%config</code> 在传入 <code>scripts/Makefile.build</code> 时就是在执行 <code>make</code> 时传入的
目标。 例如使用的是 <code>make menuconfig</code> 命令配置内核， 这里目标就是 <code>menuconfig</code>。</div>
        </div>
    </div>
<p>因为传入了参数 <code>obj=scripts/kconfig</code>， 所以 <code>srcipts/kconfig</code> 目录下的
<code>Makefile</code> 会被包含进来。 对应的 <code>%config</code> 目标也都在其中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c">################
</span></span></span><span class="line"><span class="cl"><span class="c"># Kconfig 变量定义
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">KBUILD_KCONFIG</span>
</span></span><span class="line"><span class="cl"><span class="nv">Kconfig</span> <span class="o">:=</span> <span class="k">$(</span>KBUILD_KCONFIG<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="err">else</span>
</span></span><span class="line"><span class="cl"><span class="nv">Kconfig</span> <span class="o">:=</span> Kconfig
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifndef</span> <span class="err">KBUILD_DEFCONFIG</span>
</span></span><span class="line"><span class="cl"><span class="nv">KBUILD_DEFCONFIG</span> <span class="o">:=</span> defconfig
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">###############
</span></span></span><span class="line"><span class="cl"><span class="c"># silent 变量定义
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">quiet</span><span class="k">)</span><span class="err">,silent_)</span>
</span></span><span class="line"><span class="cl"><span class="nv">silent</span> <span class="o">:=</span> -s
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">################
</span></span></span><span class="line"><span class="cl"><span class="c"># %config 目标定义
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="nf">xconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">qconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">gconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">menuconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">mconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">config</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">conf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> --oldaskconfig <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">nconfig</span><span class="o">:</span> <span class="k">$(</span><span class="nv">obj</span><span class="k">)</span>/<span class="n">nconf</span>
</span></span><span class="line"><span class="cl">	$&lt; <span class="k">$(</span>silent<span class="k">)</span> <span class="k">$(</span>Kconfig<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续以 <code>menuconfig</code> 目标为例， 它有一个依赖 <code>$(obj)/mconf</code>。 这个 <code>mconf</code> 其实是
个可执行程序， 而这里的依赖也就是它的生成过程。 关于它的生成过程也还是比较复杂的，
下面是我整理出来的它的依赖关系图， 其他的几个目标也是大同小异， 这里我就不展开分
析了。 这部分工作主要是在 <code>scripts/Makefile.host</code> 和 <code>scripts/kconfig/Makefile</code>
中实现的。</p>
<p><img
        class="lazyload"
        src="/svg/loading/small.min.svg"
        data-src="/images/posts/exploring_kbuild/menuconfig.png"
        data-srcset="/images/posts/exploring_kbuild/menuconfig.png, /images/posts/exploring_kbuild/menuconfig.png 1.5x, /images/posts/exploring_kbuild/menuconfig.png 2x"
        data-sizes="auto"
        alt="menuconfig"
        title="menuconfig" /></p>
<p>回过头来， <code>menuconfig</code> 的命令展开后是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="err">scripts/kconfig/mconf</span> <span class="err">Kconfig</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其实就是调用了生成的 <code>mconf</code> 程序， 并把 <code>Kconfig</code> 作为输入参数。 这里的
<code>Kconfig</code> 便是指源码根目录下的 <code>Kconfig</code> 文件， 目的就是用 <code>mconf</code> 去解析这个文
件。 顶层的 <code>Kconfig</code> 内容并不复杂， 基本都是去包含各个子模块下的 <code>Kconfig</code> 文件。
解析完之后开始构建初始配置数据库， 然后根据以下优先级读取现有配置文件来更新初始
数数据库：</p>
<ul>
<li>.config</li>
<li>/lib/modules/$(shell,uname -r)/.config</li>
<li>/etc/kernel-config</li>
<li>/boot/config-$(shell,uname -r)</li>
<li>ARCH_DEFCONFIG</li>
<li>arch/$(ARCH)/defconfig</li>
</ul>
<p>之后我们就可以通过 <code>GUI</code> 界面开始配置内核， 完成后会生成 <code>.config</code> 文件。所以整
个配置过程是这样的：</p>
<p><img
        class="lazyload"
        src="/svg/loading/small.min.svg"
        data-src="/images/posts/exploring_kbuild/config_flow.png"
        data-srcset="/images/posts/exploring_kbuild/config_flow.png, /images/posts/exploring_kbuild/config_flow.png 1.5x, /images/posts/exploring_kbuild/config_flow.png 2x"
        data-sizes="auto"
        alt="config flow"
        title="config flow" /></p>
<h3 id="vmlinux-生成的背后">vmlinux 生成的背后</h3>
<p>通过上面对内核配置过程的分析， <strong>kbuild</strong> 的套路也被揭露了一二。 而编译 <code>vmlinux</code>
目标可以说是 <code>kbuild</code> 系统的核心任务了。 内核的架构被分成了不同的模块， 每个模块
都由它自己在 <code>Makefile</code> 管理。 当编译内核时， 顶层的 <code>Makefile</code> 会按照正确的顺序
调用对应模块的 <code>Makefile</code>， 递归的进行编译。 因此， 内核中的 <code>Makefile</code> 也被分成
了下面的这几部分：</p>
<pre><code>Makefile		the top Makefile.
 .config			the kernel configuration file.
 arch/$(ARCH)/Makefile	the arch Makefile.
 scripts/Makefile.*	common rules etc. for all kbuild Makefiles.
 kbuild Makefiles	there are about 500 of these.
</code></pre>
<p>没错，就是在它们的共同努力下编译出了 <code>vmlinux</code>。 我把 <strong>vmlinux</strong> 编译的编译整理
成了下面这张依赖关系图：</p>
<p><img
        class="lazyload"
        src="/svg/loading/small.min.svg"
        data-src="/images/posts/exploring_kbuild/vmlinux.png"
        data-srcset="/images/posts/exploring_kbuild/vmlinux.png, /images/posts/exploring_kbuild/vmlinux.png 1.5x, /images/posts/exploring_kbuild/vmlinux.png 2x"
        data-sizes="auto"
        alt="vmlinux"
        title="vmlinux" /></p>
<p>那接下来就来讲一下编译时最核心的部分。 从上面的图中也可以看到， <code>vmlinux</code> 的依赖
有三大块。</p>
<h4 id="vmlinux-deps">$(vmlinux-deps)</h4>
<p>这部分主要是负责源码部分的编译， 从变量的名字也可以看得出，这
个变量属于 <code>vmlinux</code> 的依赖。 图中可以看到， 这部分最终的依赖基本都是名为
<code>built-in.a</code> 的文件， 那这些文件是什么呢？ 我们先来看看另一个问题， 在上面提到过，
<code>kbuild</code> 系统的编译是采用递归的方式进行的, 那这是怎么实现的呢？ 这个秘密在
<code>scripts/Makefile.build</code> 和 <code>scripts/Makefile.lib</code> 中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c"># Handle objects in subdirs
</span></span></span><span class="line"><span class="cl"><span class="c"># ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c"># o if we encounter foo/ in $(obj-y), replace it by foo/built-in.a
</span></span></span><span class="line"><span class="cl"><span class="c">#   and add the directory to the list of dirs to descend into: $(subdir-y)
</span></span></span><span class="line"><span class="cl"><span class="c"># o if we encounter foo/ in $(obj-m), remove it from $(obj-m)
</span></span></span><span class="line"><span class="cl"><span class="c">#   and add the directory to the list of dirs to descend into: $(subdir-m)
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">__subdir-y</span>	<span class="o">:=</span> <span class="k">$(</span>patsubst %/,%,<span class="k">$(</span>filter %/, <span class="k">$(</span>obj-y<span class="k">)))</span>
</span></span><span class="line"><span class="cl"><span class="nv">subdir-y</span>	<span class="o">+=</span> <span class="k">$(</span>__subdir-y<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">__subdir-m</span>	<span class="o">:=</span> <span class="k">$(</span>patsubst %/,%,<span class="k">$(</span>filter %/, <span class="k">$(</span>obj-m<span class="k">)))</span>
</span></span><span class="line"><span class="cl"><span class="nv">subdir-m</span>	<span class="o">+=</span> <span class="k">$(</span>__subdir-m<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Subdirectories we need to descend into
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">subdir-ym</span>	<span class="o">:=</span> <span class="k">$(</span>sort <span class="k">$(</span>subdir-y<span class="k">)</span> <span class="k">$(</span>subdir-m<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nv">subdir-ym</span>	<span class="o">:=</span> <span class="k">$(</span>addprefix <span class="k">$(</span>obj<span class="k">)</span>/,<span class="k">$(</span>subdir-ym<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># $(subdir-obj-y) is the list of objects in $(obj-y) which uses dir/ to
</span></span></span><span class="line"><span class="cl"><span class="c"># tell kbuild to descend
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">subdir-obj-y</span> <span class="o">:=</span> <span class="k">$(</span>filter %/built-in.a, <span class="k">$(</span>obj-y<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">$(subdir-ym)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span><span class="nv">$@</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="k">$(if</span> <span class="k">$(</span>filter <span class="nv">$@</span>/, <span class="k">$(</span>KBUILD_SINGLE_TARGETS<span class="k">))</span>,single-build<span class="o">=</span><span class="k">)</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	need-builtin<span class="o">=</span><span class="k">$(if</span> <span class="k">$(</span>filter <span class="nv">$@</span>/built-in.a, <span class="k">$(</span>subdir-obj-y<span class="k">))</span>,1<span class="k">)</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	need-modorder<span class="o">=</span><span class="k">$(if</span> <span class="k">$(</span>need-modorder<span class="k">)</span>,<span class="k">$(if</span> <span class="k">$(</span>filter <span class="nv">$@</span>/modules.order, <span class="k">$(</span>modorder<span class="k">))</span>,1<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">need-builtin</span>
</span></span><span class="line"><span class="cl"><span class="nv">builtin-target</span> <span class="o">:=</span> <span class="k">$(</span>obj<span class="k">)</span>/built-in.a
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">$(builtin-target)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">real</span>-<span class="nv">obj</span>-<span class="nv">y</span><span class="k">)</span> <span class="n">FORCE</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>call if_changed,ar_builtin<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面这些内容是从那两个 <code>Makefile</code> 中摘抄出来的， 他们并不在一起。 这点东西我觉得应该算
是 <code>kbuild</code> 系统及其核心的一个部分了。 <code>obj-y/m</code> 变量中存放的是需要编译的文件和
需要递归进入的目录。 <code>kbuild Makefiles</code> 中的内容大多都是增加它们的值。
<code>$(subdir-obj-y)</code> 变量则是从 <code>$(obj-y)</code> 中过滤出了所有的 <code>%/built-in.a</code>。
在 <code>$(subdir-ym)</code> 的命令执行时会去判断 <code>$(subdir-obj-y)</code> 变量里是否存在
<code>$@/built-in.a</code>， 如果存在自然就会有 <code>$(builtin-target)</code> 目标存在。 而
<code>$(builtin-target)</code> 目标的参数是执行了 <code>$(call if_changed,ar_builtin)</code>。
这里就不得不讲讲 <code>if_changed</code> 这个东西了， 它在 <code>kbuild</code> 中的出场率也是非常高的。
它的定义是在 <code>scripts/Kbuild.include</code> 中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="c"># echo command.
</span></span></span><span class="line"><span class="cl"><span class="c"># Short version is used, if $(quiet) equals `quiet_&#39;, otherwise full one.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">echo-cmd</span> <span class="o">=</span> <span class="k">$(if</span> <span class="k">$($(</span>quiet<span class="k">)</span>cmd_<span class="k">$(</span>1<span class="k">))</span>,<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="nb">echo</span> <span class="s1">&#39;  $(call escsq,$($(quiet)cmd_$(1)))$(echo-why)&#39;</span><span class="p">;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># printing commands
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">cmd</span> <span class="o">=</span> @set -e<span class="p">;</span> <span class="k">$(</span>echo-cmd<span class="k">)</span> <span class="k">$(</span>cmd_<span class="k">$(</span>1<span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Execute command if command has changed or prerequisite(s) are updated.
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nv">if_changed</span> <span class="o">=</span> <span class="k">$(if</span> <span class="k">$(</span>newer-prereqs<span class="k">)$(</span>cmd-check<span class="k">)</span>,                              <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="k">$(</span>cmd<span class="k">)</span><span class="p">;</span>                                                              <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s1">&#39;cmd_$@ := $(make-cmd)&#39;</span> &gt; <span class="k">$(</span>dot-target<span class="k">)</span>.cmd, @:<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出如果 <code>$(newer-prereqs)</code> 和 <code>$(cmd-check)</code> 只要有一个不为空，那么就会执行
<code>$(cmd)</code> 命令， 否则会打印一些日志。 <code>$(newer-prereqs)</code> 表示任何比目标更新或不存
在的先决条件。 <code>$(cmd-check)</code> 的作用则是检查 <code>$(cmd_@)</code> 是否为空，或者
<code>$(cmd_@)</code> 和 <code>$(cmd_$(1))</code> 是否相等。 说的简单点就是去判断了是否存在有效的
<code>$(cmd_$(1))</code> 目标。 而 <code>cmd</code> 目标实际上做了两件事： 一个是打印当前命令，第二个是
执行 <code>cmd_$(1)</code> 命令。 这里的 <code>$(1)</code> 便是调用 <code>if_changed</code> 时传入的参数。 所以
<code>$(builtin-target)</code> 目标的命令就是去执行 <code>cmd_ar_builtin</code> 目标。 而它的定义是这
样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nv">cmd_ar_builtin</span> <span class="o">=</span> rm -f <span class="nv">$@</span><span class="p">;</span> <span class="k">$(</span>AR<span class="k">)</span> cDPrST <span class="nv">$@</span> <span class="k">$(</span>real-prereqs<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这也可以看出， <code>cmd_ar_builtin</code> 命令就是将当前目录下的编译目标们都用 <code>$(AR)</code> 命
令打包成 <code>$(builtin-target)</code>， 也就是 <code>$(obj)/built-in.a</code>。 这就是在图中各个程序
模块目录下 <code>built-in.a</code> 的来源。</p>
<h4 id="autoksyms_recursive">autoksyms_recursive</h4>
<p>这部分从的功能从图中看是被分成了两个分支：</p>
<p><code>descend</code> 依赖的 <code>prepare</code> 主要是去做了一些编译前的准备工作。 例如
<code>outputmakefile</code> 是去编译输出目录生成一个 <code>Makefile</code>等。</p>
<p><code>modules.order</code> 目标的命令是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="k">$(</span><span class="nv">Q</span><span class="k">)$(</span><span class="nv">AWK</span><span class="k">)</span> <span class="s1">&#39;!x[$$0]++&#39;</span> <span class="k">$(</span><span class="nv">addsuffix</span> /<span class="k">$</span>@, <span class="k">$(</span><span class="nv">build</span>-<span class="nv">dirs</span><span class="k">))</span> <span class="err">&gt;</span> <span class="k">$@</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>它主要是生成了 <code>modules.order</code> 文件。 这个文件是用来记录编译的外部模块， 目的是
给 <code>modprobe</code> 命令加卸载模块时使用。</p>
<p>而 <code>autoksyms_recursive</code> 目标的命令是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="err">ifdef</span> <span class="err">CONFIG_TRIM_UNUSED_KSYMS</span>
</span></span><span class="line"><span class="cl"><span class="nf">autoksyms_recursive</span><span class="o">:</span> <span class="n">descend</span> <span class="n">modules</span>.<span class="n">order</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>Q<span class="k">)$(</span>CONFIG_SHELL<span class="k">)</span> <span class="k">$(</span>srctree<span class="k">)</span>/scripts/adjust_autoksyms.sh <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	  <span class="s2">&#34;</span><span class="k">$(</span>MAKE<span class="k">)</span><span class="s2"> -f </span><span class="k">$(</span>srctree<span class="k">)</span><span class="s2">/Makefile vmlinux&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">endif</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的 <code>CONFIG_TRIM_UNUSED_KSYMS</code> 默认是没有被定义的， 所以在默认情况下，这里的
命令也就不会被执行。 命令中的 <code>$(CONFIG_SHELL)</code> 在 <code>kbuild</code> 中也是比较常见的，
它的值在顶层 <code>Makefile</code>中被定义成了 <code>CONFIG_SHELL := sh</code>。 所以它的作用就是确定
了 <code>kbuild</code> 所使用的 <code>SHELL</code>。 所以上面的命令其实就是去执行了
<code>scripts/adjust_autoksyms.sh</code> 脚本。 而这个脚本的作用在脚本开头的注释中也有介绍：</p>
<pre><code># Create/update the include/generated/autoksyms.h file from the list
 # of all module's needed symbols as recorded on the second line of *.mod files.

 # For each symbol being added or removed, the corresponding dependency
 # file's timestamp is updated to force a rebuild of the affected source
 # file. All arguments passed to this script are assumed to be a command
 # to be exec'd to trigger a rebuild of those files.
</code></pre>
<p>说简单点就是生成或者更新 <code>include/generated/autoksyms.h</code> 和其他依赖文件。 所以综
合来看这部分的内容主要是做好编译前的准备工作。</p>
<h4 id="scriptslink-vmlinuxsh">scripts/link-vmlinux.sh</h4>
<p>这个脚本的作用是用于链接生成最终的 <code>vmlinux</code> 目标的。 同样的， 这个脚本开头的注
释我觉得讲的比较清楚， 也非常的有意义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Text" data-lang="Text"><span class="line"><span class="cl"># vmlinux is linked from the objects selected by $(KBUILD_VMLINUX_OBJS) and
</span></span><span class="line"><span class="cl"># $(KBUILD_VMLINUX_LIBS). Most are built-in.a files from top-level directories
</span></span><span class="line"><span class="cl"># in the kernel tree, others are specified in arch/$(ARCH)/Makefile.
</span></span><span class="line"><span class="cl"># $(KBUILD_VMLINUX_LIBS) are archives which are linked conditionally
</span></span><span class="line"><span class="cl"># (not within --whole-archive), and do not require symbol indexes added.
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># vmlinux
</span></span><span class="line"><span class="cl">#   ^
</span></span><span class="line"><span class="cl">#   |
</span></span><span class="line"><span class="cl">#   +--&lt; $(KBUILD_VMLINUX_OBJS)
</span></span><span class="line"><span class="cl">#   |    +--&lt; init/built-in.a drivers/built-in.a mm/built-in.a + more
</span></span><span class="line"><span class="cl">#   |
</span></span><span class="line"><span class="cl">#   +--&lt; $(KBUILD_VMLINUX_LIBS)
</span></span><span class="line"><span class="cl">#   |    +--&lt; lib/lib.a + more
</span></span><span class="line"><span class="cl">#   |
</span></span><span class="line"><span class="cl">#   +-&lt; ${kallsymso} (see description in KALLSYMS section)
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># vmlinux version (uname -v) cannot be updated during normal
</span></span><span class="line"><span class="cl"># descending-into-subdirs phase since we do not yet know if we need to
</span></span><span class="line"><span class="cl"># update vmlinux.
</span></span><span class="line"><span class="cl"># Therefore this step is delayed until just before final link of vmlinux.
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl"># System.map is generated to document addresses of all kernel symbols
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="构建的目标">构建的目标</h3>
<p>虽然在上面的讲述中一直是以 <code>vmlinux</code> 当作最终目标来讲的， 但是实际上如果我们在编
译内核时输入 <code>make</code> 时没有指定任何目标时， 默认目标 <code>all</code> 会使用
<code>arch/$(ARCH)/Makefile</code> 文件中定义的值。 在 <code>x86</code> 平台上是这样定义的: <code>all: bzImage</code>。 那这里就来说说 <code>vmlinux</code> 和 <code>bzImage</code> 之间的关系。</p>
<p><code>vmlinux</code> 只是编译出来的最原始的内核文件， 它的本质是一个包含静态链接，带调试信
息的 <code>ELF</code> 文件， 不带有引导信息。 而有些时候，尤其是在嵌入式 <code>ARM</code> 处理器上我们
需要的是一个可被引导的内核镜像， 而 <code>bzImage</code> 就是这样的一个目标。 一般来说， 创
建一个可引导的内核镜像时， 这个镜像都会先经过压缩处理， 而在创建好的镜像的开头会
嵌有解压代码， 这里的 <code>bzImage</code> 文件也是这样的。 它是经过了 <code>gzip</code> 和 <code>objcopy</code>
工具制作出来的压缩文件。 不仅如此， <code>bzImage</code> 文件还包含了 <code>bootsect.o</code>，
<code>setup.o</code>， <code>misc.o</code>， <code>piggy.o</code> 等内容。</p>
<h2 id="结语">结语</h2>
<p>关于 <code>kbuild</code> 系统就分析到这里了， 下面和大家分享一点我的感想。</p>
<p>从上面的讲解过程也可以看到， 我引用了很多内核里的文档和注释。 不得不说， 内核的
文档和注释真的非常值得我们学习。 从文档和注释的内容上来说， 它们可以帮助我们更好
更快的理解内核中的内容， 从编程的方面来说我们平时写程序的时候写文档写注释也应该
向内核中的文档注释学习, 即简单明了又能抓住重点理清逻辑。 当然， 不止是文档和注释，
<code>GNU Linux</code> 的内核中处处都有值得我们学习的地方, 宛如一个宝藏。</p>
<p>最后， 如果大家发现文章中有什么错误或者疑问， 欢迎留言一起交流。</p>
<hr>
<p><strong>Happy Hacking!</strong></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>本文于 2020-05-02 更新&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/60773f0ad162c04203e7a58be05fc8344ce67e19" target="_blank" title="commit by yunyanan(yunyanan1@gmail.com) 60773f0ad162c04203e7a58be05fc8344ce67e19: update LoveIt theme">
                                <i class="fas fa-hashtag fa-fw"></i>60773f0</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/exploring_kbuild/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://yunyanan.github.io/exploring_kbuild/" data-title="内核编译的背后" data-hashtags="Linux,Kernel,Kbuild,Makefile,Kconfig"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://yunyanan.github.io/exploring_kbuild/" data-hashtag="Linux"><i class="fab fa-facebook-square fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/linux/">Linux</a>,&nbsp;<a href="/tags/kernel/">Kernel</a>,&nbsp;<a href="/tags/kbuild/">Kbuild</a>,&nbsp;<a href="/tags/makefile/">Makefile</a>,&nbsp;<a href="/tags/kconfig/">Kconfig</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/linux_kernel_compile/" class="prev" rel="prev" title="编译 Linux 内核"><i class="fas fa-angle-left fa-fw"></i>编译 Linux 内核</a>
            <a href="/devicetree/" class="next" rel="next" title="DeviceTree">DeviceTree<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.93.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.4"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">YunYanan</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><script type="text/javascript">
    window.config = {"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"valine":{"appId":"Rf1OExncyuF63xO6zVHaqdrm-gzGzoHsz","appKey":"uIrFaPMGG1RgVwNJdrX1TTxa","avatar":"mp","el":"#valine","enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"Hi ^_^","recordIP":true,"visitor":true}},"headerMode":{"desktop":"fixed","mobile":"auto"}};
</script><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=Element.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2CPromise%2CObject.entries%2CObject.assign%2CObject.values%2Cfetch%2CElement.prototype.after%2CArray.prototype.fill%2CIntersectionObserver%2CArray.from%2CArray.prototype.find%2CMath.sign"></script><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/object-fit-images/ofi.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
